<!DOCTYPE html>
<html lang="en-us">
    <head>
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-81478188-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-81478188-1');
    </script>
    <meta charset="UTF-8">
    <title>Interactive Map: Taipei's Income Distribution</title>
    <style>
        #map{ width: 100%; height: 100vh;}
        div {
            font-family: "Noto Sans TC", "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;;
        }
        div.legend {
            position: absolute;
            text-align: left;
            width: 330px;
            height: 60px;
            left: 5%;
            top: 79px;
            padding: 2px;
            font: 12px "Noto Sans TC";
            background: rgba(255,255,255,0.6);
            border: 0px;
            border-radius: 4px;
            pointer-events: none;
        }
    div.title {
        position: absolute;
        text-align: left;
        color: #558C89;
        font-size: 1.5rem;
        left: 5%;
        top: 10px;
        padding: 10px;
        border: 0px;
        border-radius: 4px;
        background: rgba(255,255,255,0.6);
    }
    div.tooltip {
        position: absolute;
        text-align: center;
        width: 100px;
        height: 50px;
        padding: 5.5px 2px;
        font: 14px sans-serif;
        background: white;
        border: 0px;
        border-radius: 5px;
        pointer-events: none;
    }
    div#mapcontrol {
        position: absolute;
        text-align: left;
        left: 5%;
        top: 143px;
        font-size: 0.7rem;
        width: 6.5rem;
        padding: 0.01rem;
        border: 0px;
        border-radius: 4px;
        background: rgba(255,255,255,0.6);
        white-space: pre;
    }
    div.story {
        position: absolute;
        text-align: left;
        left: 50%;
        -ms-transform: translateX(-50%);
        -webkit-transform: translate(-50%,0);
        transform: translate(-50%,0);
        bottom: 5rem;
        width: 18rem;
        height: 7.5rem;
        padding: 0.55rem 1rem;
        font-size: 0.75rem;
        background: rgba(255,255,255,0.75);
        border: 0px;
        border-radius: 8px;
        white-space: pre;
    }
    div.distname {
        position: absolute;
        text-align: center;
        width: 5rem;
        height: 1.3rem;
        padding: 0.05rem;
        font-size: 0.8rem;
        background: rgba(255,255,255,0.75);
        border: 0px;
        border-radius: 2px;
    }
    .arrow {
        position: absolute;
        left: 45%;
        -ms-transform: translateX(-50%);
        -webkit-transform: translate(-50%,0);
        transform: translate(-50%,0);
        bottom: 0.5rem;
        width: 5rem;
        height: 2rem;    
    }
    #exit {
        position: absolute;
        right: 6px;
        top: 4px;
        width: 15px;
        height: 15px;
    }
    #boxplot {
        width: 30%;
        height: 90%;
    }
    #side {
        max-width: 50%;
        float:left;
        margin-right:2%;
    }
	.axis path,
	.axis line {
	  fill: none;
	  stroke: #000;
	  shape-rendering: crispEdges;
	}
    .chart1legend text {
    	font-weight: 400;
        font-size: 0.7rem;
    }
    .meantext, .mediantext, .q1text, .q3text {
    	font-weight: 400;
        font-size: 0.7rem;
        opacity: 0;
    }
    @media screen and (min-width: 64em) {
        #side {
            max-width: 50%; }
        #chart1 {
            width: 60vw;
            height: 45vh;}
        .x.axis text {
            font-weight: 400;
            font-size: 0.7rem;
        }
        .y.axis text {
            font-weight: 400;
            font-size: 0.8rem;
        } }
    @media screen and (min-width: 42em) and (max-width: 64em) {
        #side {
            max-width: 100%;
            clear: left;  }
        #chart1 {
            width: 100vw;
            height: 45vh;
            clear: left;  }
        .x.axis text {
            font-weight: 400;
            font-size: 0.5rem;
        }
        .y.axis text {
            font-weight: 400;
            font-size: 0.6rem;
        } }
        
    @media screen and (max-width: 42em) {
        #side {
            max-width: 100%;
            min-width: 100%;
            clear: left; }
        #chart1 {
            width: 100vw;
            height: 45vh;
            clear: left; }
        .x.axis text {
            font-weight: 400;
            font-size: 0.5rem;
        }
        .y.axis text {
            font-weight: 400;
            font-size: 0.6rem;
        } }  

    /* The switch - the box around the slider */
    .switch {
      position: relative;
      display: inline-block;
      width: 1.6rem;
      height: 0.8rem;
    }

    /* Hide default HTML checkbox */
    .switch input {display:none;}

    /* The slider */
    .sliderround {
      position: absolute;
      cursor: pointer;
      top:  0.2rem; 
      left:  0.15rem; 
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 1rem;
    }

    .sliderround:before {
      position: absolute;
      content: "";
      height: 0.65rem;
      width: 0.65rem;
      left: 0.0008rem;
      bottom: 0.015rem;
      background-color: white;
        -webkit-transition: .4s;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .sliderround {
      background-color: #74AFAD;
    }

    input:focus + .sliderround {
      box-shadow: 0 0 1px #74AFAD;
    }

    input:checked + .sliderround:before {
      -webkit-transform: translateX(0.9rem);
      -ms-transform: translateX(0.9rem);
      transform: translateX(0.9rem);
    }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta property="og:image" content="https://raw.githubusercontent.com/missmoss/taipei-stat-mrt/gh-pages/front.png"/>
    <meta property="og:description" content="On two sides of a wall, the residents' incomes can differ by ten times. This map reveals the geographical distribution of how much people earn in Taipei."/>
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen"/>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' 'type='text/css'/>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen"/>
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen"/>
    <link rel="stylesheet" href="https://npmcdn.com/leaflet@0.7.7/dist/leaflet.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/jquery.fullPage.css" />
    <script src="https://npmcdn.com/leaflet@0.7.7/dist/leaflet.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="stylesheets/scrolloverflow.min.js"></script>
    <script type="text/javascript" src="stylesheets/jquery.fullPage.js"></script>
    </head>
    
    <body>
        <div id="fullpage">
            <div class="section">
                <section class="main-content" id="front-page">
                    <img src="front.png" id="side" style="margin-right:2%;"/>
                    <h1>Interactive Map: <br>Taipei's Income Distribution</h1>
                    <p>Written, Designed and Developed by <a href="https://github.com/missmoss">@missmoss</a>
                    <br>Special Thanks to <a href="https://www.facebook.com/Cicadatatw/">Cicadata TW</a>, <a href="https://www.facebook.com/TalkEcon/">Talkecon</a></p>
                    <p>On two sides of a wall, the residents' incomes can differ by ten times.
This map reveals the geographical distribution of how much people earn in Taipei.</p>
                    <p>(Recommend to read on computer for better browsing experiences)</p>
                    <p><a href="zh.html" id="smaller">中文(Traditional Chinese)</a></p>
                </section>
            </div>
            <div class="section">
                <section class="main-content">
                    <p>Saturday night, the lights are still on at a law firm on Dunhua South Road at  11:00. Lawyer C and his colleagues have been preparing for an upcoming crucial court session for weeks. In the windowless cellular office of C's, it's hard to notice the transition of day and night. The to-do list on the desk is the only changing thing.</p>
                    <p>"I can't finish all these works without overtime." the two-year-practice lawyer told me, "At weekends, I'm either at the office or work at home with my laptop and documents."</p>
                    <p>With up to 90 work hours per week, C has a nice salary people would admire. He earned 1m NTD (3.3k USD) in his first practice year at age 25. However, in C's hometown, Nanhu Village in Neihu District, his annual salary is a bit lower than the median income of the village. That is, half of tax units (we can think it as households)  have higher annual income than lawyer C.</p>
                    <p>Taiwan's white-collar see an annual income of one million NTD (3.3k USD) as an achievement. Yet an income of one million is only middle-class. More than 25% households in Taipei earn less than 0.4 million NTD (1.3k USD) yearly. The income is hardly enough for one to live in Taipei. Let alone the income is probably for a whole family, not a person.</p>
                    <p>In big Taipei area, geographical income distribution can help us to understand the differences among districts. Through statistics, we try to discuss: <b>Where the high-income people live? Within districts, what differences exist?</b></p>
                </section>
            </div>
            <div class="section">
                <div id="map">
                </div>
            </div>
            <div class="section">
                <section class="main-content">
                    <h2>A world divided by the wall</h2>
                    <p>Among the ordinary five-to-seven-floor apartment buildings which are common in Taipei, there are several buildings hidden in high walls and surrounded by tall bushy trees in a lane of Mingsheng East Road. It looks mysterious.</p>
                    <p>These buildings are located in Dongcheng Village, Songshan Dist. The data from Financial Data Center reveals some clues:</p>
                    <table id="no-more-tables">
                        <thead>
                            <tr>
                                <th>District</th>
                                <th>Village</th>
                                <th>Total Income of the Village</th>
                                <th>Tax Unit</th>
                                <th>Average</th>
                                <th>First Quartile</th>
                                <th>Midian</th>
                                <th>Third Quartile</th>
                                <th>Standard Deviation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td data-title="District">Songshan</td>
                                <td data-title="Village">Dongcheng</td>
                                <td data-title="Total Income of the Village">9836m</td>
                                <td data-title="Tax Unit">917</td>
                                <td data-title="Average">1.07m</td>
                                <td data-title="First Quartile">0.47m</td>
                                <td data-title="Midian">0.9m</td>
                                <td data-title="Third Quartile">1.8m</td>
                                <td  data-title="Standard Deviation">261760.57</td>
                            </tr>
                        </tbody>
                    </table>
                    <blockquote>
                        <h4>Tax Unit</h4>
                        <p>A group of individuals who pays tax as a unit, usually are parents and children or spouses. One can pay tax alone. Our data is based on tax units. Hence, we don't know the income comes from one person or is the total of many family members. We can consider a tax unit is a co-living group and people in the group share the income and expenditure.</p>
                    </blockquote>
                    <p>Ordering all tax units in Dongcheng Village from small to large, and finding the record exactly in the 25%, 50%, and 75% percentile, that's how we get the first quartile, median and third quartile.</p>
                    <p>From the data above, we know the residents of Dongcheng Village in 0-25% percentile earn 0-0.5 million NTD (0-1.7k USD) yearly. The median income of Dongcheng Village is 0.9 million NTD (30k USD). It ranks 37 out of 456 villages in Taipei. It looks nice, but not the top ones. The third quantile is 1.8 million NTD (60k USD), ranked 59, still far from the top tiers.</p>
                    <h2>The Insane Amount of Income in the Wall</h2>
                    <p>Dongcheng Village seems ordinary - as the buildings surrounded by trees are - in income distribution in Taipei.</p>
                    <p>However, the average income of Dongcheng Village has been long occupied the top 1 in Taipei, even in Taiwan, for years. In the 2014 statistics, the number is amazing 10.7 million NTD (0.36 million USD).</p>
                    <p><b>The average income of Dongcheng Village is far from its median, also much higher in times than its third quantile, suggests that there are one or more taxpayers earn an insane amount of money yearly.</b></p>
                    <p>We can give a simple estimate of the amount. Let's assume 0-25% quantiles all earn 0.5 million NTD (1.7k USD), 25-50% all earn 0.9 million NTD (30k USD), and 50-75% all earn 1.8 million NTD (60k USD). For the rest 75-100% we don't have a statistics to follow, let's say all earn 20 million NTD (0.67 million USD). Then we have the total income of the village minus the previously assumed amount of income and divide by a pre-set tax unit numbers. Finally, we can get the annual income of these super-earners.</p>
                    <h3>Assumption 1: 10 hyper income tax units</h3>
                    <table id="no-more-tables">
                        <thead>
                            <tr>
                            	<th>Income Group</br>Assumed Income</th>
                                <th>25%</br>0.47m</th>
                                <th>50%</br>0.9m</th>
                                <th>75%</br>1.8m</th>
                                <th>100%</br>20m</th>
                                <th>Hyper Income Units</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td data-title="Income Group">Units</td>
                                <td data-title="25%">230</td>
                                <td data-title="50%">230</td>
                                <td data-title="75%">230</td>
                                <td data-title="100%">217</td>
                                <td data-title="Hyper Income Units">10</td>
                            </tr>
                            <tr>
                                <td data-title="Income Group">Group Total Income</td>
                                <td data-title="25%">110m</td>
                                <td data-title="50%">215m</td>
                                <td data-title="75%">418m</td>
                                <td data-title="100%">4340m</td>
                                <td data-title="Hyper Income">4754m</td>
                            </tr>
                            <tr>
                            	<td data-title="Hyper Income Units"><b>Average Income of Each Unit</b></td>
                            	<td></td>
                            	<td></td>
                            	<td></td>
                            	<td></td>
                            	<td><font color="#558C89">~470m</font></td>
                            </tr>
                        </tbody>
                    </table>
                    <h3>Assumption 2: 50 hyper income tax units</h3>
                    <table id="no-more-tables">
                        <thead>
                            <tr>
                            	<th>Income Group</br>Assumed Income</th>
                                <th>25%</br>0.47m</th>
                                <th>50%</br>0.9m</th>
                                <th>75%</br>1.8m</th>
                                <th>100%</br>20m</th>
                                <th>Hyper Income Units</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td data-title="Income Group">Units</td>
                                <td data-title="25%">230</td>
                                <td data-title="50%">230</td>
                                <td data-title="75%">230</td>
                                <td data-title="100%">177</td>
                                <td data-title="Hyper Income Units">50</td>
                            </tr>
                            <tr>
                                <td data-title="Income Group">Group Total Income</td>
                                <td data-title="25%">110m</td>
                                <td data-title="50%">215m</td>
                                <td data-title="75%">418m</td>
                                <td data-title="100%">3540m</td>
                                <td data-title="Hyper Income Units">5554m</td>
                            </tr>
                            <tr>
                            	<td data-title="Hyper Income Units"><b>Average Income of Each Unit</b></td>
                            	<td></td>
                            	<td></td>
                            	<td></td>
                            	<td></td>
                            	<td><font color="#558C89">~110m</font></td>
                            </tr>
                        </tbody>
                    </table>
                    <p>As a result, the mysterious super-earners have an annual income of at least 100 million NTD (3 million USD). The real number should be more since we overestimate others' income. If looking into the numbers in details, we can find the total income of other tax units would be slightly fewer than the super-earners.</p>
                    <h2>Where is the wealthy neighborhood?</h2>
                    <p>How many villages in Taipei having the similarly huge income inequality?</p>
                    <div id="chart1">
                    </div>
                    <p>Figure 1. Income Inequality Within District</p>
                    <p>In figure 1, we plot the statistics of top 10 villages in average income. We can see what these villages are and how far its average from its median and third quantile.</p>
                    <h2>10%？1%？0.1%？</h2>
                    <p>We may imagine, the commonly thought wealthy districts, such as Daan Dist in the central of Taipei, gathered top 10% wealthy people, to be specific, top 10% earners. The villages with super high average income, have the top 1% wealthy people. Where the rich guys live? This is a question everyone curious about. Through map and statistics, we try to understand the geographical distribution of high-income people.</p>
                    <p>Besides the curiosity about how rich people's lives are, we have more questions based on the explorations above: Is wealth people's income stable? What's the difference between their income sources and average people's? Do these differences tell us anything? In the following research, we will continue to explore these questions through financial and tax open data. If anything interesting found, we will keep sharing.</p>
                </section>
                <section class="main-content">
                	<hr>
                    <h3>Interactive Map: Taipei's Income Distribution</h3>
                    <p>A heat map of 2014 median annual income of villages in Taipei and New Taipei City. The pinker the color is, the higher the median income is. The more green, the lower the median income. The median statistics merely tell us a general view of the geographical distribution. It cannot show the complete distribution among all households. It cannot reveal the differences in households. The residents who didn't register can be counted in neither.</p>
                    <p>The tax data released by Financial Data Center always takes long to processed and checked so it usually delays for two years. This project was originally developed in 2016 and used the updated data at that time, which is 2014 data. The distribution changes hugely in recent years, we will try to explore and share new findings when we get some!</p>
                    <h3>Data Sources</h3>
                    Tax Data: </br>2014／<a href="http://www.fia.gov.tw/ct.asp?xItem=3451&ctNode=668&mp=1">Financial Data Center of Minstry of Finance</a> <a href="https://github.com/leeneil">、@leeneil</a> at <a href="https://github.com/cicadatatw>@cicadatatw">@cicadatatw</a>'s <a href="https://github.com/cicadatatw/taiwan-income-by-village"> pdf/csv convertion</a></br>
                    2012／<a href="http://data.gov.tw/">Open Data Gov Taiwan</a>: <a href="http://data.gov.tw/node/17983">Taipei</a>、<a href="http://data.gov.tw/node/17975">New Taipei</a></br>
                    MRT Station Location: <a href="https://github.com/repeat" class="user-mention">@repeat</a>  <a href="https://github.com/repeat/taipei-metro-stations">taipei-metro-stations</a>
                    <h3>Derived from</h3>
                    <a href="http://missmoss.github.io/taipei-mrt-viz/">A Day in Taipei Metro</a></br>
                    <footer class="site-footer">
                        <span class="site-footer-owner"><a href="https://github.com/missmoss/taipei-stat-mrt">Taipei Income Map</a> is produced by <a href="https://github.com/missmoss"> @missmoss</a></span>
                        <span class="site-footer-credits">This page is a <a href="https://pages.github.com">GitHub Pages</a> which is edited from <a href="https://twitter.com/jasonlong">Jason Long</a>'s <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a>。Special thanks to Miss Monday、Wu-Hsi、Duckling、Yoyo、Nan、Kn、TalkEcon authors for help and discussion in project development.</span>
                    </footer>
                    
                </section>
            </div>
        </div>
        
        <script>
            var subdist, interactive, stationName, firstTime = false, exit = false;

            $(document).ready(function() {
                $('#fullpage').fullpage({

                    // scrolling
                    scrollOverflow: true,
                    // for mobile
                    scrollHorizontally: true,
                    // event
                    afterLoad: function(anchorLink, index){
                        var loadedSection = $(this);

                        //using index
                        if ( index === 3 && firstTime === false ) {
                            firstTime = true;
                            storyTeller();
                        }
                    },
                    onLeave: function(index, nextIndex, direction){
                        if ( index === 1 ) {
                            directionArrow.remove();
                        } else if ( index === 3 ) {
                            exit = true;
                            distname.style("opacity", 0);
                            tooltip.style("opacity", 0);
                            subdist.style("opacity", 0.475);
                            story.remove();
                            interactive();
                        }
                    },
                })
            });
            
            /* Set up Leaflet.js map */
            var northEast = L.latLng(25.3,122),
            southWest = L.latLng(24.7,121.258),
            bounds = L.latLngBounds(southWest, northEast);

            /* CARTODB BASEMAP */
            var carto = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
                subdomain: 'abcd'
                });

            var satellite = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });
            
        
        var map = L.map('map', {
            scrollWheelZoom: false,
            doubleClickZoom: false,
            center: [25.045,121.547],
            zoom: 13,
            zoomControl: false,
            maxBounds: bounds
            });

        //add zoom control with your options
        L.control.zoom({
             position:'topright'
        }).addTo(map);
        
        map.addLayer(carto);
        
        /* Initialize the SVG layer */
        map._initPathRoot()
        
        /* Set up svg and some elements for charts */
        
        /* svg1 for Heatmap */
        /* We simply pick up the SVG from the map object */

        var directionArrow = d3.select("body")
        .append("div")
        .attr("class", "arrow")
        .append("svg");

        setTimeout(function() {
            directionArrow
            .append("path")
            .attr("d", "m0,0L30,25L60,0L60,7L30,32L0,7z")
            .attr("fill", "#d0d0d0")
            .attr("transform", "translate(0, -20)")
            .transition()
            .duration(500)
            .attr("transform", "translate(0, 0)");

            directionArrow
            .append("text")
            .attr("x", 65)
            .attr("y", 0)
            .attr("fill", "#d0d0d0")
            .style("font-size", "1rem")
            .text("Scroll Down to Next Page")
            .transition()
            .duration(500)
            .attr("y", 17);
        }, 1000);
        
        var svg1 = d3.select("#map").select("svg");
        g = svg1.append("g");

        var title = d3.select("#map").append("div")
        .attr("class", "title");
        
        title.text("Taipei Income Map");
        
        var legend = d3.select("#map").append("div")
        .attr("class", "legend");

        var mapcontrol = d3.select("#map").append("div")
        .attr("id", "mapcontrol");
        
        var label1 = d3.select("#mapcontrol")
        .append("div")
        .append("label")
        .attr("class", "switch")
        .text("　　　MRT Line");
        
        label1.append("input")
        .attr("type", "checkbox")
        .attr("checked", true)
        .attr("id", "mrtline");
        label1.append("div")
        .attr("class", "sliderround");

        var label2 = d3.select("#mapcontrol")
        .append("div")
        .append("label")
        .attr("class", "switch")
        .text("　　　MRT Station");
        
        label2.append("input")
        .attr("type", "checkbox")
        .attr("id", "station");
        label2.append("div")
        .attr("class", "sliderround");

        var label3 = d3.select("#mapcontrol")
        .append("div")
        .append("label")
        .attr("class", "switch")
        .text("　　　Satellite");
        
        label3.append("input")
        .attr("type", "checkbox")
        .attr("id", "satellite");
        label3.append("div")
        .attr("class", "sliderround");

        d3.select("#satellite").on("change", changeMap);

        function changeMap() {
            var check = this.checked;
            if (check === true) {
                map.removeLayer(carto);
                map.addLayer(satellite);
                stationName.attr("fill", "white");
            } else {
                map.removeLayer(satellite);
                map.addLayer(carto);
                stationName.attr("fill", "black");
            }
        }

        var tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

        var distname = d3.select("body").append("div")
        .attr("class", "distname")
        .style("opacity", 0);
        
        
        var svg2 = d3.select(map.getPanes().overlayPane).append("svg"),
        g2 = svg2.append("g").attr("class", "dist");
        g3 = svg2.append("g").attr("class", "station");

        var story = d3.select("#map").append("div")
        .attr("class", "story");
        
        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        d3.json("twnsub3.json", function(collection) {
            
            var incomeMedian = collection.features.map(function(item) {
                return parseInt(item.properties.INCOME_MEDIAN);
            }
            )
            
            var extent = d3.extent(incomeMedian),
            middle = (extent[0]+extent[1])/2;
            
            var fillColor = d3.scale.linear()
            .domain([extent[0], middle, extent[1]])
            //.range(["#7CFFDE", "#5468E8", "#E84374"]);
            .range(["#52FFB0", "#5468E8", "#E84374"]);
            //.range(["#00A388", "#FFF457", "#E8518E"]);
        
            var fillOpacity = d3.scale.linear()
            .domain(extent)
            //.range(["#52FFB0", "#5468E8", "#E84374"]);
            .range([0.35, 0.55]);
            
            //legend
            var legendData = [300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200];
            
            var rectWidth = 27;
            
            legend = legend.append("svg").attr("width", rectWidth*12);
            
            legend.append("text")
            .attr("x", 5)
            .attr("y", 18)
            .attr("fill", "#6C6C6C")
            .style("font-size", 14)
            .text("Median Annual Income of Village in Taipei");
            
            legend.selectAll(".legend")
            .data(legendData)
            .enter()
            .append("rect")
            .attr("x", function(d,i) { return 10+rectWidth*i; })
            .attr("y", 25)
            .attr("width", rectWidth)
            .attr("height", 10)
            .attr("fill", function(d) { return fillColor(d); })
            .style("opacity", 0.4);
            
            legend.selectAll(".legendtext")
            .data(legendData)
            .enter()
            .append("text")
            .attr("text-anchor", "start")
            .attr("x", function(d,i) { return 5+rectWidth*i; })
            .attr("y", 50)
            .attr("fill", "#6C6C6C")
            .text(function(d) { return d/1000;});
            
            legend.append("text")
            .attr("text-anchor", "start")
            .attr("x", rectWidth*10+3)
            .attr("y", 49)
            .attr("fill", "#6C6C6C")
            .text("m NTD");   
            
            var transform = d3.geo.transform({point: projectPoint}),
            path = d3.geo.path().projection(transform);
            
            subdist = g2.selectAll(".subdist")
            .data(collection.features)
            .enter().append("path")
            .attr("stroke", "white")
            .attr("stroke-width", 0.5)
            .attr("class", function(d) { return d.properties.TOWN; }) //class=中正區/大安區/松山區...etc
            .attr("id", function(d) { return d.properties.VILLAGE; }) //id=華城里/政大里/龍門里...etc
            .attr("fill", function(d) {
                
                // Get data value
                var value = d.properties.INCOME_MEDIAN;
                
                if (value) {
                    //If value exists…
                    return fillColor(value);
                } else {
                    //If value is undefined…
                    return "white";
                }
            })
            .style("opacity", 0.475);

            interactive = function () {
                subdist.on("mouseover", function(d) {
                    d3.select(this)
                    .style("opacity", 0.85);
                    tooltip.transition()
                    .duration(200)
                    .style("opacity", 0.9);
                    tooltip.text(function () {
                        return d.properties.TOWN+'\n'+
                        d.properties.VILLAGE+'\n'+
                        numberWithCommas(d.properties.INCOME_MEDIAN)+',000 NTD';
                    })
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("click", function(d) {
                    d3.select(this)
                    .style("opacity", 0.85);
                    tooltip.transition()
                    .duration(200)
                    .style("opacity", 0.9);
                    tooltip.text(function () {
                        return d.properties.TOWN+'\n'+
                        d.properties.VILLAGE+'\n'+
                        numberWithCommas(d.properties.INCOME_MEDIAN)+',000 NTD';
                    })
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    d3.select(this)
                    .style("opacity", 0.475)
                    tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
                });
            }
            
            //d3 code stolen from http://bost.ocks.org/mike/leaflet/#init
            
            map.on("viewreset", reset);
            reset();
            
            function reset() {
                var topobounds = path.bounds(collection),
                topLeft = topobounds[0],
                bottomRight = topobounds[1];
                
                svg2.attr("width", bottomRight[0] - topLeft[0])
                .attr("height", bottomRight[1] - topLeft[1])
                .style("left", topLeft[0] + "px")
                .style("top", topLeft[1] + "px");
                g2.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
                
                subdist.attr("d", path);
            }

            function projectPoint(x, y) {
                var point = map.latLngToLayerPoint(new L.LatLng(y, x));
                this.stream.point(point.x, point.y);
            }   
            
        });
        
        //twnsublatlng.json Village_NLSC_121_1050219 25.0853403,121.4231634
        
        
        d3.csv("taipei.csv", function(data) {
            
            var transform = d3.geo.transform({point: projectPoint}),
            d3path = d3.geo.path().projection(transform);

            function projectPoint(x, y) {
                var point = map.latLngToLayerPoint(new L.LatLng(x, y));
                this.stream.point(point.x, point.y);
            } 
            
            var lines = {
            "1":{
                color: "brown",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }}, 
            "2": {
                color: "red",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "3": {
                color: "green",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "4": {
                color: "orange",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "4-1": {
                color: "orange",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "5": {
                color: "blue",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "n": {
                color: "red",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "s": {
                color: "green",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }}
            };
            
            data.forEach(function(d) {
                lines[d.line_no].geoLineString.coordinates.push(
                [parseFloat(d.lat), parseFloat(d.lon)]);
            });

            var keys = d3.keys(lines).filter(function(key, d) {
                return key;
            });
            
            var lines2 = [];
            
            keys.forEach(function(key) {
                var tmpdata = lines[key];
                tmpdata['line_no'] = key;
                lines2.push(tmpdata);
            });
            
            var linePath = g.selectAll(".lineConnect")
            .data(lines2)
            .enter()
            .append("path")
            .attr("class", "lineConnect")
            .attr("id", function(d) {return d.line_no; })
            .attr("stroke", function(d) { return d.color; })
            .attr("stroke-width", 1.5)
            .attr("fill", "None")
            .style("opacity", 1)
            .attr("d", function(d) { return d3path(d.geoLineString); });

            d3.select("#mrtline").on("change", switchLine);

            function switchLine() {
                var check = this.checked;
                if (check === true) {
                    linePath.style("opacity", 1);
                } else {
                    linePath.style("opacity", 0);
                }
            }

            var stations = g.selectAll(".circle")
            .data(data)
            .enter()
            .append("circle")
            .attr("r", 3.5)
            .attr("cx", function(d) { return map.latLngToLayerPoint(new L.LatLng(d.lat, d.lon)).x;})
            .attr("cy", function(d) { return map.latLngToLayerPoint(new L.LatLng(d.lat, d.lon)).y;})
            .attr("class", "circle")
            .attr("stroke", function(d) { return lines[d.line_no].color; } )
            .attr("stroke-width", 1.5)
            .attr("fill", "#fff")
            .style("opacity", 0);

            stationName = g2.selectAll(".station-name")
            .data(data)
            .enter()
            .append("text")
            .attr("class", "station-name")
            .attr("id", function(d) { return d.id; })
            .attr("fill", "black")
            .style("font-size", 10)
            .text(function(d) { return d.name; } )
            .style("opacity", 0);
            
            map.on("viewreset", updateMap);
            updateMap();

            d3.select("#station").on("change", switchStation);

            function switchStation() {
                var check = this.checked;
                if (check === true) {
                    stations.style("opacity", 1);
                    stationName.style("opacity", 1);
                } else {
                    stations.style("opacity", 0);
                    stationName.style("opacity", 0);
                }
            }

            function updateMap() {
                linePath.attr("d", function(d) { return d3path(d.geoLineString); });
                stationName.attr("transform", function(d) { 
                    d.x = map.latLngToLayerPoint(new L.LatLng(d.lat, d.lon)).x+7.5;
                    d.y = map.latLngToLayerPoint(new L.LatLng(d.lat, d.lon)).y+2;
                    return "translate("+d.x +","+d.y +")rotate(-20)";
                });
                stations.attr("cx", function(d) { return map.latLngToLayerPoint(new L.LatLng(d.lat, d.lon)).x;})
                .attr("cy", function(d) { return map.latLngToLayerPoint(new L.LatLng(d.lat, d.lon)).y;});
            }

        }); //end of d3.csv("taipei.csv")
            

        function storyTeller() {
            // start
            var i = 0,
            r = $.Deferred();

            var storyData = [
            { type: 0, pan: [25.0656575,121.5896828], selector: "sub", target: "寶湖里", text: "#1 Baohu Village, Neihu, Taipei\nMedian Income: 1.24m NTD (41.3k USD)\nMajor Property: Villa House\nHousing Price: Villa 30-50m NTD (1-1.6m USD)"},
            { type: 0, pan: [24.9896,121.59], selector: "sub", target: "政大里", text: "#2  Chengda Village, Wenshan, Taipei\nMedian Income: 1.23m NTD (41k USD)\nMajor Property: Villa House\nHousing Price: House 40m NTD (1.3m USD),\n Apartment 0.7m NTD(23k USD)/35.6 sq ft" },
           { type: 0, pan: [24.9263674,121.4975], selector: "sub", target: "華城里", text: "#3 Huacheng Village, Xindian, New Taipei City\nMedian Income：1.2m NTD (40k USD)\nMajor Property: Villa House\nHousing Price: Villa 30-50m NTD (1-1.6m USD)" },
            { type: 2, pan: [25.045,121.547], center: [[25.0292997,121.5030736], [25.0263064,121.5263363], [25.0645017,121.4959642], [25.0601717,121.5417976], [25.0287132,121.5548065], [25.0294912,121.4803741]], selector: "dist", target: ["中正區", "大安區", "大同區", "松山區", "信義區", "萬華區"], text: "In the central area of Taipei, Zongcheng, Daan, Datong, Songshan and Xinyi District have a relatively consistent color within the district. It means the income distribution is comparatively even in the district." },
            { type: 3, pan: [25.045,121.547], center: [[24.991582, 121.572439], [25.088473, 121.593980], [25.06,121.532]], selector: "dist", target: ["文山區", "內湖區", "中山區"], text: "Wenshan, Neihu and Zongshan District have one or few villages with distinctly high median income, suggests that inequality within the district." },
            { type: 0, pan: [25.045,121.547], center: [25.0263064,121.5263363], selector: "none", target: "", text: "Now, it's your time exploring the map!\nOr scroll down for more stories." }
            ]  

            function storyLine() {
                var type = storyData[i].type,
                pan = storyData[i].pan,
                center = storyData[i].center,
                target = storyData[i].target,
                text = storyData[i].text,
                selector;


                if (storyData[i].selector === "sub") {
                    selector = "#";
                } else if (storyData[i].selector === "dist") {
                    selector = ".";
                } else {
                    selector = "";
                }

                if (type === 0) {
                    type0();
                } else if (type === 1) {
                    type1();
                } else if (type === 2) {
                    type2();
                } else if (type === 3) {
                    type3();
                }

                story.text(text);

                var exitBtn = story.append("svg")
                .attr("id", "exit")
                .append("path")
                .attr("class", "btn")
                .attr("d", "m0,0L5,5L10,10L5,5L0,10L5,5L10,0L5,5z")
                .attr("stroke-width", 4)
                .attr("stroke", "#d0d0d0")
                .attr("transform", "translate(4,4)")
                .on("mouseover", function(){
                    d3.select(this)
                    .attr("stroke", "#74AFAD");
                })
                .on("mouseout", function(){
                    d3.select(this)
                    .attr("stroke", "#d0d0d0");
                })
                .on("click", function() {
                    exit = true;
                    distname.style("opacity", 0);
                    tooltip.style("opacity", 0);
                    subdist.style("opacity", 0.475);
                    story.remove();
                    interactive();
                    map.panTo([25.045,121.547]);
                });

                if (i === storyData.length-1) {
                    interactive();
                    setTimeout(function() {
                        distname.remove();
                        story.style("opacity", 0);
                    }, 4000);
                }

                function type0() {

                    if (exit === false) {

                        if (selector === "#") {
                            d3.select(selector+target)
                            .style("opacity", 0.85);
                        } else if (selector === ".") {
                            d3.selectAll(selector+target)
                            .style("opacity", 0.85);                        
                        }

                        map.panTo(pan);

                        if (i < storyData.length-1) {
                            setTimeout(function () {
                                clickNext();
                            }, 3500);
                        } else {
                            exit = true;
                            distname.style("opacity", 0);
                        }
                    } else {
                        return;
                    }

                } // end of type0()


                function type1() {

                    if (exit === false) {

                        map.panTo(pan);

                        var textPosition = map.latLngToLayerPoint(new L.LatLng(center[0], center[1]));

                        if (selector === "#") {
                            d3.select(selector+target)
                            .style("opacity", 0.85);
                        } else if (selector === ".") {
                            d3.selectAll(selector+target)
                            .style("opacity", 0.85);                        
                        };

                        d3.select(".story")
                        .style("white-space", "pre-wrap");

                        distname.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                        distname.text(function () {
                                return target;
                        })
                        .style("left", (textPosition.x + 10) + "px")
                        .style("top", (textPosition.y - 28) + "px");

                        if (i < storyData.length-1) {
                            setTimeout(function () {
                                clickNext();
                            }, 3500);
                        } else {
                            exit = true;
                            distname.style("opacity", 0);
                        }
                    } else {
                        return;
                    }

                } // end of type1()

                function type2() {

                    if (exit === false) {

                        map.panTo(pan);

                        var j = 0, n = target.length, current = i;

                        d3.select(".story")
                        .style("white-space", "pre-wrap");
                                
                        function show() {

                            if ( current !== i | exit === true ) {
                                clearInterval(distSwitch);
                                return;
                            }

                            var textPosition = map.latLngToLayerPoint(new L.LatLng(center[j][0], center[j][1]));

                            // remove previous
                            subdist.style("opacity", 0.475);
                            distname.style("opacity", 0);
                            // highlight current
                            if (selector === "#") {
                                d3.select(selector+target[j])
                                .style("opacity", 0.85);
                            } else {
                                d3.selectAll(selector+target[j])
                                .style("opacity", 0.85);                      
                            }
                            distname.style("opacity", 0.9);

                            distname.text(function () {
                                return target[j];
                            })
                            .style("left", (textPosition.x + 10) + "px")
                            .style("top", (textPosition.y - 28) + "px");

                            j++;

                            if ( j >= n ) {
                                clearInterval(distSwitch);
                            }
                        }

                        show();
                        var distSwitch;
                        setTimeout(function() {
                            distSwitch = setInterval(show, 1500);
                        }, 2000);


                        if (i < storyData.length-1) {
                            setTimeout(function () {
                                clickNext();
                            }, 1500*n+4000);
                        } else {
                            exit = true;
                            distname.style("opacity", 0);
                        };
                    } else {
                        return;
                    }

                }  // end of type2()


                function type3() {

                    if (exit === false) {

                        var j = 0, n = target.length, current = i;

                        d3.select(".story")
                        .style("white-space", "pre-wrap");
                            
                        function show() {

                            if ( current !== i | exit === true ) {
                                clearInterval(distSwitch);
                                return;
                            }

                            // remove previous
                            subdist.style("opacity", 0.475);
                            distname.style("opacity", 0);
                            // highlight current
                            if (selector === "#") {
                                d3.select(selector+target[j])
                                .style("opacity", 0.85);
                            } else {
                                d3.selectAll(selector+target[j])
                                .style("opacity", 0.85);                        
                            }
                            map.panTo(center[j]);
                            distname.style("opacity", 0.9);

                            distname.text(function () {
                                return target[j];
                            })
                            .style("left", "49%")
                            .style("top", "50%");
                            
                            j++;

                            if ( j >= n ) {
                                clearInterval(distSwitch);
                            }
                        }

                        show();
                        var distSwitch;
                        setTimeout(function() {
                            distSwitch = setInterval(show, 1500);
                        }, 2000);

                        if (i < storyData.length-1) {
                            setTimeout(function () {
                                clickNext();
                            }, 2500*n+4000);
                        } else {
                            exit = true;
                            distname.style("opacity", 0);
                        }
                    } else {
                        return;
                    }
                    
                
                }  // end of type3()

                
            } // end of storyLine();

            function clickBack() {
                subdist.style("opacity", 0.475);
                distname.style("opacity", 0);
                i--;
                storyLine();
            }


            function clickNext() {
                subdist.style("opacity", 0.475);
                distname.style("opacity", 0);
                i++;
                storyLine();
            }

            storyLine();

        } // end of storyTeller() 

        // remove all after display. navigation? color? mapcontrol?

        // chart1
        var citydata = {
            "tpe": { "q1": 392, "median": 732, "q3": 1427, "mean": 1434},
            "ntp": { "q1": 360, "median": 600, "q3": 1054, "mean": 895}
        };

        var subdistdata = [
		  {
		    "dist": "松山區",
		    "subdist": "Dongcheng",
		    "mean": 10.7,
		    "median": 0.94,
		    "q1": 0.47,
		    "q3": 1.82
		  },
		  {
		    "dist": "信義區",
		    "subdist": "Xinlong",
		    "mean": 9.08,
		    "median": 0.81,
		    "q1": 0.37,
		    "q3": 1.90
		  },
		  {
		    "dist": "士林區",
		    "subdist": "Chingshan",
		    "mean": 6.10,
		    "median": 0.65,
		    "q1": 0.39,
		    "q3": 1.08
		  },
		  {
		    "dist": "士林區",
		    "subdist": "Yongfu",
		    "mean": 5.95,
		    "median": 0.79,
		    "q1": 0.42,
		    "q3": 1.70
		  },
		  {
		    "dist": "士林區",
		    "subdist": "Hsinan",
		    "mean": 5.79,
		    "median": 0.64,
		    "q1": 0.34,
		    "q3": 1.43
		  },
		  {
		    "dist": "中正區",
		    "subdist": "Dongmen",
		    "mean": 5.43,
		    "median": 0.89,
		    "q1": 0.46,
		    "q3": 1.89
		  },
		  {
		    "dist": "大安區",
		    "subdist": "Minhui",
		    "mean": 4.31,
		    "median": 0.94,
		    "q1": 0.44,
		    "q3": 2.10
		  },
		  {
		    "dist": "松山區",
		    "subdist": "Fucheng",
		    "mean": 4.16,
		    "median": 0.91,
		    "q1": 0.43,
		    "q3": 1.88
		  },
		  {
		    "dist": "信義區",
		    "subdist": "Ankan",
		    "mean": 4.15,
		    "median": 0.99,
		    "q1": 0.47,
		    "q3": 2.18
		  },
		  {
		    "dist": "中山區",
		    "subdist": "Hsinfu",
		    "mean": 4.10,
		    "median": 0.62,
		    "q1": 0.35,
		    "q3": 1.16
		  }
		]

        var chart1width = parseInt(d3.select("#chart1").style("width")), 
        chart1height = parseInt(d3.select("#chart1").style("height"));
        
        var chart1 = d3.select("#chart1").append("svg")
        .attr("width", chart1width)
        .attr("height", chart1height)
        .append("g")
        .attr("transform", "translate(" + chart1width*0.03 + "," + chart1height*0.01 + ")");

        var x = d3.scale.ordinal()
        .domain(subdistdata.map(function(a) { return a.subdist; }))
        .rangePoints([chart1width*0.05, chart1width*0.8]);

        var xBand = d3.scale.ordinal()
        .domain(subdistdata.map(function(a) { return a.subdist; }))
        .rangeRoundBands([0, chart1width*0.85]);
        
        var y = d3.scale.linear()
        .range([chart1height*0.85, 10]);
        
        var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");
        
        var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");

        var mean = d3.svg.line()
        .x(function(d) { return x(d.subdist); })
        .y(function(d) { return y(d.mean); });
        
        var median = d3.svg.line()
        .x(function(d) { return x(d.subdist); })
        .y(function(d) { return y(d.median); });
        
        y.domain([0, d3.max(subdistdata, function(d) { return d.mean; })]);

        chart1.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + (chart1height*0.85) + ")")
        .call(xAxis)
        .selectAll("text")
	    .attr("transform", "rotate(25)")
	    .style("text-anchor", "start");
        
        chart1.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + 10 +",0)")
        .call(yAxis)
        .append("text")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .attr("fill", "#558C89")
        .style("font-weight", 400)
        .attr("transform", "rotate(-90)")
        .text("Annual Income(Unit: m NTD)");

        chart1.selectAll(".mean")
		.data(subdistdata)
		.enter().append("circle")
		.attr("class", "mean")
		.attr("id", function(d) { return "c"+d.subdist; })
		.attr("r", 3.5)
		.attr("cx", function(d) { return x(d.subdist); })
		.attr("cy", function(d) { return y(d.mean); })
		.style("fill", "#EB7F00")
		.on("mouseover", chart1mouseover)
		.on("mouseout", chart1mouseout)
		
		chart1.selectAll(".meantext")
		.data(subdistdata)
		.enter().append("text")
		.attr("class", "meantext")
		.attr("id", function(d) { return "tt"+d.subdist; })
		.attr("x", function(d) { return x(d.subdist)+6; })
		.attr("y", function(d) { return y(d.mean)+3; })
		.text(function(d) { return d.mean; });

		chart1.selectAll(".median")
		.data(subdistdata)
		.enter().append("circle")
		.attr("class", "median")
		.attr("id", function(d) { return "c"+d.subdist; })
		.attr("r", 3.5)
		.attr("cx", function(d) { return x(d.subdist); })
		.attr("cy", function(d) { return y(d.median); })
		.style("fill", "#1595A3")
		.on("mouseover", chart1mouseover)
		.on("mouseout", chart1mouseout);

		chart1.selectAll(".mediantext")
		.data(subdistdata)
		.enter().append("text")
		.attr("class", "mediantext")
		.attr("id", function(d) { return "tt"+d.subdist; })
		.attr("x", function(d) { return x(d.subdist)+6; })
		.attr("y", function(d) { return y(d.median)+3; })
		.text(function(d) { return d.median; });


		chart1.selectAll(".q1")
		.data(subdistdata)
		.enter().append("circle")
		.attr("class", "q1")
		.attr("id", function(d) { return "c"+d.subdist; })
		.attr("r", 3.5)
		.attr("cx", function(d) { return x(d.subdist); })
		.attr("cy", function(d) { return y(d.q1); })
		.style("fill", "#ACF0F2")
		.on("mouseover", chart1mouseover)
		.on("mouseout", chart1mouseout);

		chart1.selectAll(".q1text")
		.data(subdistdata)
		.enter().append("text")
		.attr("class", "q1text")
		.attr("id", function(d) { return "tt"+d.subdist; })
		.attr("x", function(d) { return x(d.subdist)+6; })
		.attr("y", function(d) { return y(d.q1)+8; })
		.text(function(d) { return d.q1; });

		chart1.selectAll(".q3")
		.data(subdistdata)
		.enter().append("circle")
		.attr("class", "q3")
		.attr("id", function(d) { return "c"+d.subdist; })
		.attr("r", 3.5)
		.attr("cx", function(d) { return x(d.subdist); })
		.attr("cy", function(d) { return y(d.q3); })
		.style("fill", "#225378")
		.on("mouseover", chart1mouseover)
		.on("mouseout", chart1mouseout);

		chart1.selectAll(".q3text")
		.data(subdistdata)
		.enter().append("text")
		.attr("class", "q3text")
		.attr("id", function(d) { return "tt"+d.subdist; })
		.attr("x", function(d) { return x(d.subdist)+6; })
		.attr("y", function(d) { return y(d.q3)+3; })
		.text(function(d) { return d.q3; });

		chart1.selectAll(".chart1rect")
		.data(subdistdata)
		.enter().append("rect")
		.attr("class", "chart1rect")
		.attr("id", function(d) { return "r"+d.subdist; })
		.attr("x", function(d) { return xBand(d.subdist); })
        .attr("width", xBand.rangeBand())
        .attr("y", 0 )
		.attr("height", chart1height*0.85 )
		.attr("fill", "black")
		.style("opacity", 0)
		.on("mouseover", chart1mouseover)
		.on("mouseout", chart1mouseout);

		var color = [
		{"name": "Average", "color": "#EB7F00"},
		{"name": "Third Quartile", "color": "#225378"},
		{"name": "Median", "color": "#1595A3"},
		{"name": "First Quartile", "color": "#ACF0F2"},
		]

		var chart1legend = chart1.selectAll(".chart1legend")
		.data(color)
		.enter().append("g")
		.attr("class", "chart1legend")
		.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

		chart1legend.append("rect")
		.attr("x", chart1width*0.8)
		.attr("width", 17)
		.attr("height", 17)
		.style("fill", function(d) {return d.color});

		chart1legend.append("text")
		.attr("x", chart1width*0.795)
		.attr("y", 9)
		.attr("dy", ".35em")
		.style("text-anchor", "end")
		.text(function(d) { return d.name; });

		function chart1mouseover(d) {
			d3.selectAll("#c"+d.subdist)
			.attr("r", 5);
			d3.selectAll("#tt"+d.subdist)
			.style("opacity", 1);
		}

		function chart1mouseout(d) {
			d3.selectAll("#c"+d.subdist)
			.attr("r", 3.5);
			d3.selectAll("#tt"+d.subdist)
			.style("opacity", 0);
		}

        </script>
    </body>
</html>
