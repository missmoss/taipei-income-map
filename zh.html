<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="UTF-8">
            <title>互動地圖：雙北所得大解密</title>
            <style>
                #map{ width: 100%; height: 100vh;}
                div {
                    font-family: "Noto Sans TC", "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;;
                }
                div.legend {
                    position: absolute;
                    text-align: left;
                    width: 310px;
                    height: 60px;
                    left: 5%;
                    top: 79px;
                    padding: 2px;
                    font: 12px "Noto Sans TC";
                    background: rgba(255,255,255,0.6);
                    border: 0px;
                    border-radius: 4px;
                    pointer-events: none;
                }
            div.title {
                position: absolute;
                text-align: left;
                color: #558C89;
                font-size: 1.5rem;
                left: 5%;
                top: 10px;
                padding: 10px;
                border: 0px;
                border-radius: 4px;
                background: rgba(255,255,255,0.6);
            }
            div.tooltip {
                position: absolute;
                text-align: center;
                width: 100px;
                height: 35px;
                padding: 5.5px 2px;
                font: 14px sans-serif;
                background: white;
                border: 0px;
                border-radius: 8px;
                pointer-events: none;
            }
            div#mapcontrol {
                position: absolute;
                text-align: left;
                left: 5%;
                top: 143px;
                font-size: 0.7rem;
                width: 6rem;
                padding: 0.01rem;
                border: 0px;
                border-radius: 4px;
                background: rgba(255,255,255,0.6);
                white-space: pre;
            }
            div.story {
                position: absolute;
                text-align: left;
                left: 50%;
                -ms-transform: translateX(-50%);
                -webkit-transform: translate(-50%,0);
                transform: translate(-50%,0);
                bottom: 5rem;
                width: 17rem;
                height: 7.5rem;
                padding: 0.55rem 2.3rem;
                font-size: 0.75rem;
                background: rgba(255,255,255,0.6);
                border: 0px;
                border-radius: 8px;
                white-space: pre;
            }
            div.distname {
                position: absolute;
                text-align: center;
                width: 5rem;
                height: 1.3rem;
                padding: 0.05rem;
                font-size: 0.8rem;
                background: rgba(255,255,255,0.75);
                border: 0px;
                border-radius: 2px;
            }
            .arrow {
                position: absolute;
                left: 45%;
                -ms-transform: translateX(-50%);
                -webkit-transform: translate(-50%,0);
                transform: translate(-50%,0);
                bottom: 0.5rem;
                width: 5rem;
                height: 2rem;    
            }
            #back {
                position: absolute;
                left: 0rem;
                top: 1.25rem;
                width: 1.5rem;
                height: 5rem;
            }
            #next {
                position: absolute;
                right: 0rem;
                top: 1.25rem;
                width: 1.5rem;
                height: 5rem;
            }
            #exit {
                position: absolute;
                right: 6px;
                top: 4px;
                width: 15px;
                height: 15px;
            }
            #boxplot {
                width: 30%;
                height: 90%;
            }
            #side {
                max-width: 50%;
                float:left;
                margin-right:2%;
            }
			.axis path,
			.axis line {
			  fill: none;
			  stroke: #000;
			  shape-rendering: crispEdges;
			}
            .chart1legend text {
            	font-weight: 400;
                font-size: 0.7rem;
            }
            .meantext, .mediantext, .q1text, .q3text {
            	font-weight: 400;
                font-size: 0.7rem;
                opacity: 0;
            }
            @media screen and (min-width: 64em) {
                #side {
                    max-width: 50%; }
                #chart1 {
                    width: 60vw;
                    height: 30vh;}
                .x.axis text {
	                font-weight: 400;
	                font-size: 0.7rem;
	            }
	            .y.axis text {
	                font-weight: 400;
	                font-size: 0.8rem;
	            } }
            @media screen and (min-width: 42em) and (max-width: 64em) {
                #side {
                    max-width: 100%;
                    clear: left;  }
                #chart1 {
                    width: 100vw;
                    height: 40vh;
                    clear: left;  }
                .x.axis text {
	                font-weight: 400;
	                font-size: 0.5rem;
	            }
	            .y.axis text {
	                font-weight: 400;
	                font-size: 0.6rem;
	            } }
	            
            @media screen and (max-width: 42em) {
                #side {
                    max-width: 100%;
                    min-width: 100%;
                    clear: left; }
                #chart1 {
                    width: 100vw;
                    height: 40vh;
                    clear: left; }
                .x.axis text {
	                font-weight: 400;
	                font-size: 0.5rem;
	            }
	            .y.axis text {
	                font-weight: 400;
	                font-size: 0.6rem;
	            } }  
            /* The switch - the box around the slider */
.switch {
  position: relative;
  display: inline-block;
  width: 1.6rem;
  height: 0.8rem;
}

/* Hide default HTML checkbox */
.switch input {display:none;}

/* The slider */
.sliderround {
  position: absolute;
  cursor: pointer;
  top:  0.2rem; 
  left:  0.15rem; 
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
  border-radius: 1rem;
}

.sliderround:before {
  position: absolute;
  content: "";
  height: 0.65rem;
  width: 0.65rem;
  left: 0.0008rem;
  bottom: 0.015rem;
  background-color: white;
    -webkit-transition: .4s;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .sliderround {
  background-color: #74AFAD;
}

input:focus + .sliderround {
  box-shadow: 0 0 1px #74AFAD;
}

input:checked + .sliderround:before {
  -webkit-transform: translateX(0.9rem);
  -ms-transform: translateX(0.9rem);
  transform: translateX(0.9rem);
}
            </style>
            <meta name="viewport" content="width=device-width, initial-scale=1"/>
            <meta property="og:image" content="https://raw.githubusercontent.com/missmoss/taipei-stat-mrt/gh-pages/front.png"/>
            <meta property="og:description" content="台北的有錢人都住在大安區嗎？圍牆內外，居民收入竟是百萬與千萬的差別？雙北所得分布地圖帶你一窺大台北地區的所得樣貌。"/>
            <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen"/>
            <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' 'type='text/css'/>
            <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen"/>
            <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen"/>
            <link rel="stylesheet" href="https://npmcdn.com/leaflet@0.7.7/dist/leaflet.css" />
            <link rel="stylesheet" type="text/css" href="stylesheets/jquery.fullPage.css" />
            <script src="https://npmcdn.com/leaflet@0.7.7/dist/leaflet.js"></script>
            <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
            <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
            <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
            <script src="https://d3js.org/d3.v3.min.js"></script>
            <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
            <script type="text/javascript" src="stylesheets/scrolloverflow.min.js"></script>
            <script type="text/javascript" src="stylesheets/jquery.fullPage.js"></script>
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
            
            ga('create', 'UA-81478188-1', 'auto');
            ga('send', 'pageview');
            
                </script>
            </head>
    
    <body>
        <div id="fullpage">
            <div class="section">
                <section class="main-content">
                    <img src="front.png" id="side" style="margin-right:2%;"/>
                    <h1>互動地圖：<br>雙北所得大解密</h1>
                    <p>製作／<a href="https://github.com/missmoss">@missmoss</a></p>
                    <p>協力／<a href="https://www.facebook.com/Cicadatatw/">知了新聞</a>、<a href="https://www.facebook.com/TalkEcon/">白經濟</a></p>
                    <p>台北的有錢人都住在大安區嗎？圍牆內外，居民收入竟是百萬與千萬的差別？雙北所得分布地圖帶你一窺大台北地區的所得樣貌。</p>
                    <p>（為達最佳瀏覽效果，建議使用電腦版閱讀。）</font></p>
                    <p><a href="index.html">英文(English Version)</a></p>
                </section>
            </div>
            <div class="section">
                <section class="main-content">
                    <p>星期五晚上11點，敦化南路上的律師事務所仍然燈火通明，C 律師與同事們正為了下週即將開庭的大案積極備戰。在 C 沒有對外窗的裡間獨立辦公室，感覺不到日夜的更迭，唯一明確變動的，只有眼前待解決的工作數量。「不加班，根本做不完。」</p>
                    <p>入行兩年的 C 說：「週末，我不是在辦公室，就是抱著卷宗和電腦在家趕工。」</p>
                    <p>每週工時上看 90 小時的 C ，有著大多數人稱羨的薪水：出社會第一年、25 歲就年薪百萬。然而，在 C 家所在的內湖區南湖里，他的年薪還比整個里的所得中位數低一些，表示南湖里有一半以上的家庭，年收入都比 C 律師還要來得高。</p>
                    <p>上班族追逐的年薪百萬，在台北市只能算是中產，更有 25% 的家庭，一年的所得總額低於 40 萬元。這樣的薪水，在台北市生活尚且不容易，更何況這 40 萬元可能要養活的是一整個家庭。</p>
                    <p>在大台北地區，所得的空間分布可以一窺區域差異，透過簡單的統計指標，我們嘗試討論：<b>雙北地區的高所得居民集中在哪？區域的內部，又有著什麼樣的差異？</b></p>
                </section>
            </div>
            <div class="section">
                <section class="main-content">
                    <h2>雙北地區所得前十名</h2>
                    <div>
                        <div id="side">
                            <table>
                                <thead>
                                    <tr>
                                        <th>排名</th>
                                        <th>縣市</th>
                                        <th>鄉鎮市區</th>
                                        <th>村里</th>
                                        <th>所得中位數</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td>台北市</td>
                                        <td>內湖區</td>
                                        <td>寶湖里</td>
                                        <td>124.0萬</td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td>台北市</td>
                                        <td>文山區</td>
                                        <td>政大里</td>
                                        <td>123.6萬</td>
                                    </tr>
                                    <tr>
                                        <td>3</td>
                                        <td>新北市</td>
                                        <td>新店區</td>
                                        <td>華城里</td>
                                        <td>119.7萬</td>
                                    </tr>
                                    <tr>
                                        <td>4</td>
                                        <td>台北市</td>
                                        <td>內湖區</td>
                                        <td>金湖里</td>
                                        <td>118.3萬</td>
                                    </tr>
                                    <tr>
                                        <td>5</td>
                                        <td>台北市</td>
                                        <td>中山區</td>
                                        <td>成功里</td>
                                        <td>116.4萬</td>
                                    </tr>
                                    <tr>
                                        <td>6</td>
                                        <td>台北市</td>
                                        <td>內湖區</td>
                                        <td>南湖里</td>
                                        <td>112.0萬</td>
                                    </tr>
                                    <tr>
                                        <td>7</td>
                                        <td>台北市</td>
                                        <td>大安區</td>
                                        <td>光明里</td>
                                        <td>106.9萬</td>
                                    </tr>
                                    <tr>
                                        <td>8</td>
                                        <td>台北市</td>
                                        <td>南港區</td>
                                        <td>重陽里</td>
                                        <td>106.5萬</td>
                                    </tr>
                                    <tr>
                                        <td>9</td>
                                        <td>台北市</td>
                                        <td>大安區</td>
                                        <td>龍門里</td>
                                        <td>105.7萬</td>
                                    </tr>
                                    <tr>
                                        <td>10</td>
                                        <td>台北市</td>
                                        <td>大安區</td>
                                        <td>福住里</td>
                                        <td>105.1萬</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p style="font-size: 0.7rem;">資料來源：103年所得稅統計資料</p>
                            <hr class="narrowonly">
                        </div>
                        <div>
                            <p>被網友戲稱為天龍國的台北市大安區，印象中向來是有錢人才住得起的地方，也被認為應該是台灣平均收入最高的一群，若將年度家戶所得依各村里中位數排出前十名，大安區雖然無法拔得頭籌，卻囊括了十名中的七、九、十名，區內各里也都在台北市的前段班。</p>
                            <h3>位於市郊的領先群組</h3>
                            <p>前五名中的文山區政大里、新店區華城里及內湖區金湖里均是相對市郊、環山抱翠，聚集了不少喜歡清幽的有錢人。</p>
                            <h3>明星學區長青不衰</h3>
                            <p>其他入榜的村里均位於市區，鄰近明星學區、醫院、科技公司聚集處，內湖區寶湖里鄰近三總、國防醫學院，中山區成功里即明水路一帶，著名的大直水岸第一排就座落於此，大安區光明里臨中正紀念堂，為明星學校中正國中學區，南港區重陽里也臨河，近南港軟體園區，內湖區南湖里在哈拉影城後方，中正區新營里為中正紀念堂、羅斯福路及杭州南路所夾三角地區，也是中正國中學區，龍門里則被大安森林公園、台大、名校龍門國中所環繞，福住里在金華國中、大安森林公園旁。</p>
                            <blockquote>
                                <h4>為什麼使用中位數</h4>
                                <p>中位數是將原始資料排序後，位於正中間（50%）的數值。在所得資料中，平均數常常被少數高所得的極端值拉高，使得平均數有時難以衡量一個群體的大致收入樣貌，所以我們採用中位數，以求貼近一般的所得水準。</p>
                            </blockquote>
                        </div>
                        </section>
            </div>
            <div class="section">
                <div id="map">
                </div>
            </div>
            <div class="section">
                <section class="main-content">
                    <h2>一道圍牆，兩個世界</h2>
                    <p>民生東路四段巷內，台北市隨處可見的五到七樓高華廈住宅群中，有幾棟並不特別華麗大氣、卻由高聳圍牆、濃密樹蔭與監視器所環繞的半新大樓，森嚴的戒備與低調外觀平添了神秘感。</p>
                    <p>這些大樓位於松山區東昌里。財稅中心公布的各村里所得總額統計數字，或可提供一些線索：</p>
                    <table id="no-more-tables">
                        <thead>
                            <tr>
                                <th>區域</th>
                                <th>村里</th>
                                <th>區域所得總額</th>
                                <th>納稅單位</th>
                                <th>平均</th>
                                <th>第一分位數</th>
                                <th>中位數</th>
                                <th>第三分位數</th>
                                <th>標準差</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td data-title="區域">松山區</td>
                                <td data-title="村里">東昌里</td>
                                <td data-title="區域所得總額">983657萬</td>
                                <td data-title="納稅單位">917</td>
                                <td data-title="平均">1072.7萬</td>
                                <td data-title="第一分位數">47.4萬</td>
                                <td data-title="中位數">93.6萬</td>
                                <td data-title="第三分位數">181.6萬</td>
                                <td  data-title="標準差">261760.57</td>
                            </tr>
                        </tbody>
                    </table>
                    <blockquote>
                        <h4>稅收資料的單位</h4>
                        <p>因為稅籍資料以報稅單位為最小單位，我們無法得知究竟人們是單獨報稅、夫妻報稅或是整個家庭一起報稅，但我們可以將每個報稅單位視為一組共同生活的小群體，想像他們的收入及支出是共用的。</p>
                    </blockquote>
                    <p>將所有資料從最小到最大排序，依序找出排在 25%、50% 及 75% 位置的資料，這就是第一分位數、中位數和第三分位數的概念。從所得總額的資料中，我們可以知道排序在收入最低 0-25% 的東昌里設籍家戶／居民，年度所得介於 0-47.4 萬間。中位數 93.6 萬，位於台北市 456 個里的第 37 名，屬於前段班，但絕無擠進前十名的機會。即使是位於整個里 75% 的高收入族群，年度所得也只在 181.6 萬，排名台北市第 59。</p>
                    <h2>圍牆內的天文數字</h2>
                    <p>乍看之下，東昌里只是一個收入屬於台北市前段班的普通村里。</p>
                    <p>然而，松山區東昌里整個區域的平均年度所得總額，卻長期盤踞北市、甚至全台的第一名寶座。103 年度的統計中，這個數字是驚人的 1072.7 萬。</p>
                    <p><b>遠高於中位數、甚至是第三分位數數倍的平均數，暗示著東昌里的 917 個納稅單位中，有一位或多位納稅人，有著天文數字般的所得總額。</b></p>
                    <p>我們可以嘗試做個簡單的估計：假設 0-25% 的人收入都是 47.4 萬、25-50% 的人收入都是 93.6 萬，50-75% 的人收入都是 181.6 萬，剩下的 75-100% 收入設定個 2000 萬好了，再用整區所得總額 983657 萬，減掉前面估計出的所得總額，再除以我們設定的納稅單位數量，來看看這些拉高平均的納稅單位，年度所得總額到底有多高。</p>
                    <h3>假設 1：10 個超高收入納稅單位</h3>
                    <table id="no-more-tables">
                        <thead>
                            <tr>
                            	<th>所得族群</br>假設所得總額</th>
                                <th>25%</br>47.4萬</th>
                                <th>50%</br>93.6萬</th>
                                <th>75%</br>181.6萬</th>
                                <th>100%</br>2000萬</th>
                                <th>超高收入納稅單位</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td data-title="所得族群">單位數</td>
                                <td data-title="25%">230</td>
                                <td data-title="50%">230</td>
                                <td data-title="75%">230</td>
                                <td data-title="100%">217</td>
                                <td data-title="超高收入">10</td>
                            </tr>
                            <tr>
                                <td data-title="所得族群">分組所得總額</td>
                                <td data-title="25%">10971萬</td>
                                <td data-title="50%">21528萬</td>
                                <td data-title="75%">41768萬</td>
                                <td data-title="100%">434000萬</td>
                                <td data-title="超高收入">475399萬</td>
                            </tr>
                            <tr>
                            	<td data-title="超高收入"><b>平均每單位所得總額</b></td>
                            	<td></td>
                            	<td></td>
                            	<td></td>
                            	<td></td>
                            	<td><font color="#558C89">約 4 億 7 千萬</font></td>
                            </tr>
                        </tbody>
                    </table>
                    <h3>假設 2：50 個超高收入納稅單位</h3>
                    <table id="no-more-tables">
                        <thead>
                            <tr>
                            	<th>所得族群</br>假設所得總額</th>
                                <th>25%</br>47.4萬</th>
                                <th>50%</br>93.6萬</th>
                                <th>75%</br>181.6萬</th>
                                <th>100%</br>2000萬</th>
                                <th>超高收入納稅單位</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td data-title="所得族群">單位數</td>
                                <td data-title="25%">230</td>
                                <td data-title="50%">230</td>
                                <td data-title="75%">230</td>
                                <td data-title="100%">177</td>
                                <td data-title="超高收入">50</td>
                            </tr>
                            <tr>
                                <td data-title="所得族群">分組所得總額</td>
                                <td data-title="25%">10971萬</td>
                                <td data-title="50%">21528萬</td>
                                <td data-title="75%">41768萬</td>
                                <td data-title="100%">354000萬</td>
                                <td data-title="超高收入">555399萬</td>
                            </tr>
                            <tr>
                            	<td data-title="超高收入"><b>平均每單位所得總額</b></td>
                            	<td></td>
                            	<td></td>
                            	<td></td>
                            	<td></td>
                            	<td><font color="#558C89">約 1 億 1 千萬</font></td>
                            </tr>
                        </tbody>
                    </table>
                    <p>從上面的估計中可以發現，這些神秘的大戶每年至少有上億的收入。由於我們已經非常高估其他人的所得，神秘大戶的報稅收入，應該會比剛剛估算的數字更多一些。如果仔細觀察數字的分布，還可發現，整個東昌里其他納稅單位的全部所得加起來，可能還比大戶們的所得少一些。</p>
                    <h2>有錢的鄰居在哪裡</h2>
                    <p>像這樣在同一個區域內，所得分配有巨大差異的狀況，到底有多少呢？</p>
                    <div id="chart1">
                    </div>
                    <p>圖 1：區域內部所得分配差異</p>
                    <p>在圖 1 中，我們繪出平均所得總額前十名的村里的各項統計數字，稍微觀察一下這些平均數遠高於中位數、甚至第三分位數的區域，分別是哪些村里，差距又有多大。不過除了長據第一的松山區東昌里，因為位於敦化北路台塑總部後方，據傳是台塑集團王永在家族的居住地之外，其他的村里我們暫時找不到資料，足以解釋造成平均數飆高的原因。</p>
                    <h2>10%？1%？0.1%？</h2>
                    <p>我們或可想像，一般印象中的大安區、或者一開始的中位數前十名各里，住著台灣／雙北地區排名 10% 左右的有錢人，但超高平均數呈現出的，可能是 1%、甚至 0.1% 的有錢人。有錢人在哪裡？這是一個大家都好奇的問題。藉由地圖和統計資料的觀察，我們嘗試描繪高所得人群的空間分布。</p>
                    <p>不過，在想了解有錢人生活的好奇心之外，我們或許可以提出更多問題：有錢人的收入穩定嗎？他們的收入來源和一般人有什麼差別？這些差別，有沒有可能告訴我們什麼？接下來，我們會嘗試使用稅務資料繼續研究這些問題，如果發現了有趣的結果，再和大家分享。</p>
                </section>
            <!--
            <div class="section">
            <section class="main-content">
            <h1>我是h1</h1>
            <h2>我是h2</h2>
            <h3>我是h3</h3>
            <h4>我是h4</h4>
            <h5>我是h5</h5>
            <p>我是p</p>
            <pre><code>我是code</code></pre>
            <blockquote>
            <h4>我是小框框標題</h4>
            <p>我是小框框內容</p>
            </blockquote>
            </section>
            </div>
            -->
                <section class="main-content">
                	<hr>
                    <h3>互動地圖：雙北所得大解密</h3>
                    <p>將台北市、新北市 103 年所得稅統計資料各村里綜合所得稅所得總額中位數畫成熱圖，顏色越粉紅，所得稅中位數越高，顏色越綠，該村里所得稅中位數越低。中位數僅能大致窺見區域分布差異，無法完全衡量實際分布，也無法顯示出家戶內部的所得差異。未設籍在居住地的人口也無法被計入。</p>
                    <p>另所得稅統計資料處理過程繁複，需時較久，目前資料僅釋出至 103 年度，故以 103 年度資料討論及作圖。</p>
                    <h3>資料來源</h3>
                    所得稅統計資料：103 年／<a href="http://www.fia.gov.tw/ct.asp?xItem=3451&ctNode=668&mp=1">財政部財政資訊中心</a> <a href="https://github.com/leeneil">、@leeneil</a> 在 <a href="https://github.com/cicadatatw>@cicadatatw">@cicadatatw</a> 的 <a href="https://github.com/cicadatatw/taiwan-income-by-village"> pdf/csv 轉檔</a></br>
                    101 年／<a href="http://data.gov.tw/">政府資料開放平台</a> <a href="http://data.gov.tw/node/17983">台北市</a>、<a href="http://data.gov.tw/node/17975">新北市</a></br>
                    捷運站點位置： <a href="https://github.com/repeat" class="user-mention">@repeat</a> 的 <a href="https://github.com/repeat/taipei-metro-stations">taipei-metro-stations</a>
                    <h3>延伸自</h3>
                    <a href="http://missmoss.github.io/taipei-mrt-viz/">台北捷運一日進出站流量</a></br>
                    <footer class="site-footer">
                        <span class="site-footer-owner"><a href="https://github.com/missmoss/taipei-stat-mrt">雙北所得分布地圖</a> 由 <a href="https://github.com/missmoss"> @missmoss</a> 製作。</span>
                        <!--<span class="site-footer-credits">The front photo is via courtesy of <a href="https://www.flickr.com/photos/lipon/11730442194/">liponan</a>.</span>-->
                        <span class="site-footer-credits">本頁面是 <a href="https://pages.github.com">GitHub Pages</a> ，修改自由 <a href="https://twitter.com/jasonlong">Jason Long</a> 製作的 <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a>。特別感謝 Miss Monday、務熙學長、鴨鴨、有有、南哥、Kn、白經濟作者群在製作過程的討論與協助。</span>
                    </footer>
                    
                </section>
            </div>
        </div>
        
        <script>
            var subdist, interactive, stationName, firstTime = false, exit = false;

            $(document).ready(function() {
                $('#fullpage').fullpage({

                    // scrolling
                    scrollOverflow: true,
                    // for mobile
                    scrollHorizontally: true,
                    // event
                    afterLoad: function(anchorLink, index){
                        var loadedSection = $(this);

                        //using index
                        if ( index === 4 && firstTime === false ) {
                            firstTime = true;
                            storyTeller();
                        }
                    },
                    onLeave: function(index, nextIndex, direction){
                        if ( index === 1 ) {
                            directionArrow.remove();
                        } else if ( index === 4 ) {
                            exit = true;
                            distname.style("opacity", 0);
                            tooltip.style("opacity", 0);
                            subdist.style("opacity", 0.475);
                            story.remove();
                            interactive();
                        }
                    },
                })
            });
            
            /* Set up Leaflet.js map */
            var northEast = L.latLng(25.3,122),
            southWest = L.latLng(24.7,121.258),
            bounds = L.latLngBounds(southWest, northEast);
            
            /* Hydda.Base MAP 
            var layer = L.tileLayer('http://{s}.tile.openstreetmap.se/hydda/base/{z}/{x}/{y}.png', {
    attribution: 'Tiles courtesy of <a href="http://openstreetmap.se/" target="_blank">OpenStreetMap Sweden</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
});
            */

            /* CARTODB BASEMAP */
            var carto = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
                subdomain: 'abcd'
                });

            var satellite = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });
            
        
        var map = L.map('map', {
            scrollWheelZoom: false,
            doubleClickZoom: false,
            center: [25.045,121.547],
            zoom: 13,
            zoomControl: false,
            maxBounds: bounds
            });

        //add zoom control with your options
        L.control.zoom({
             position:'topright'
        }).addTo(map);
        
        map.addLayer(carto);
        
        /* Initialize the SVG layer */
        map._initPathRoot()
        
        /* Set up svg and some elements for charts */
        
        /* svg1 for Heatmap */
        /* We simply pick up the SVG from the map object */

        var directionArrow = d3.select("body")
        .append("div")
        .attr("class", "arrow")
        .append("svg");

        setTimeout(function() {
            directionArrow
            .append("path")
            .attr("d", "m0,0L30,25L60,0L60,7L30,32L0,7z")
            .attr("fill", "#d0d0d0")
            .attr("transform", "translate(0, -20)")
            .transition()
            .duration(500)
            .attr("transform", "translate(0, 0)");

            directionArrow
            .append("text")
            .attr("x", 65)
            .attr("y", 0)
            .attr("fill", "#d0d0d0")
            .style("font-size", "1rem")
            .text("往下滑動到下一頁")
            .transition()
            .duration(500)
            .attr("y", 17);
        }, 1000);
        
        var svg1 = d3.select("#map").select("svg");
        g = svg1.append("g");

        var title = d3.select("#map").append("div")
        .attr("class", "title");
        
        title.text("雙北所得地圖");
        
        var legend = d3.select("#map").append("div")
        .attr("class", "legend");

        var mapcontrol = d3.select("#map").append("div")
        .attr("id", "mapcontrol");
        
        var label1 = d3.select("#mapcontrol")
        .append("div")
        .append("label")
        .attr("class", "switch")
        .text("　　　捷運線");
        
        label1.append("input")
        .attr("type", "checkbox")
        .attr("checked", true)
        .attr("id", "mrtline");
        label1.append("div")
        .attr("class", "sliderround");

        var label2 = d3.select("#mapcontrol")
        .append("div")
        .append("label")
        .attr("class", "switch")
        .text("　　　捷運站點");
        
        label2.append("input")
        .attr("type", "checkbox")
        .attr("id", "station");
        label2.append("div")
        .attr("class", "sliderround");

        var label3 = d3.select("#mapcontrol")
        .append("div")
        .append("label")
        .attr("class", "switch")
        .text("　　　衛星地圖");
        
        label3.append("input")
        .attr("type", "checkbox")
        .attr("id", "satellite");
        label3.append("div")
        .attr("class", "sliderround");

        d3.select("#satellite").on("change", changeMap);

        function changeMap() {
            var check = this.checked;
            if (check === true) {
                map.removeLayer(carto);
                map.addLayer(satellite);
                stationName.attr("fill", "white");
            } else {
                map.removeLayer(satellite);
                map.addLayer(carto);
                stationName.attr("fill", "black");
            }
        }

        var tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

        var distname = d3.select("body").append("div")
        .attr("class", "distname")
        .style("opacity", 0);
        
        
        var svg2 = d3.select(map.getPanes().overlayPane).append("svg"),
        g2 = svg2.append("g").attr("class", "dist");
        g3 = svg2.append("g").attr("class", "station");

        var story = d3.select("#map").append("div")
        .attr("class", "story");
        
        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        d3.json("twnsub3.json", function(collection) {
            
            var incomeMedian = collection.features.map(function(item) {
                return parseInt(item.properties.INCOME_MEDIAN);
            }
            )
            
            var extent = d3.extent(incomeMedian),
            middle = (extent[0]+extent[1])/2;
            
            var fillColor = d3.scale.linear()
            .domain([extent[0], middle, extent[1]])
            //.range(["#7CFFDE", "#5468E8", "#E84374"]);
            .range(["#52FFB0", "#5468E8", "#E84374"]);
            //.range(["#00A388", "#FFF457", "#E8518E"]);
        
            var fillOpacity = d3.scale.linear()
            .domain(extent)
            //.range(["#52FFB0", "#5468E8", "#E84374"]);
            .range([0.35, 0.55]);
            
            //legend
            var legendData = [300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200];
            
            var rectWidth = 27;
            
            legend = legend.append("svg");
            
            legend.append("text")
            .attr("x", 5)
            .attr("y", 18)
            .attr("fill", "#6C6C6C")
            .style("font-size", 14)
            .text("雙北各里年度家戶所得中位數");
            
            legend.selectAll(".legend")
            .data(legendData)
            .enter()
            .append("rect")
            .attr("x", function(d,i) { return 10+rectWidth*i; })
            .attr("y", 25)
            .attr("width", rectWidth)
            .attr("height", 10)
            .attr("fill", function(d) { return fillColor(d); })
            .style("opacity", 0.4);
            
            legend.selectAll(".legendtext")
            .data(legendData)
            .enter()
            .append("text")
            .attr("text-anchor", "start")
            .attr("x", function(d,i) { return 5+rectWidth*i; })
            .attr("y", 50)
            .attr("fill", "#6C6C6C")
            .text(function(d) { return d/10;});
            
            legend.append("text")
            .attr("text-anchor", "start")
            .attr("x", rectWidth*10+5)
            .attr("y", 49)
            .attr("fill", "#6C6C6C")
            .text("萬元");   
            
            var transform = d3.geo.transform({point: projectPoint}),
            path = d3.geo.path().projection(transform);
            
            subdist = g2.selectAll(".subdist")
            .data(collection.features)
            .enter().append("path")
            .attr("stroke", "white")
            .attr("stroke-width", 0.5)
            .attr("class", function(d) { return d.properties.TOWN; }) //class=中正區/大安區/松山區...etc
            .attr("id", function(d) { return d.properties.VILLAGE; }) //id=華城里/政大里/龍門里...etc
            .attr("fill", function(d) {
                
                // Get data value
                var value = d.properties.INCOME_MEDIAN;
                
                if (value) {
                    //If value exists…
                    return fillColor(value);
                } else {
                    //If value is undefined…
                    return "white";
                }
            })
            .style("opacity", 0.475);

            interactive = function () {
                subdist.on("mouseover", function(d) {
                    d3.select(this)
                    .style("opacity", 0.85);
                    tooltip.transition()
                    .duration(200)
                    .style("opacity", 0.9);
                    tooltip.text(function () {
                        return d.properties.TOWN+'\n'+
                        d.properties.VILLAGE+'\n'+
                        numberWithCommas(d.properties.INCOME_MEDIAN)+',000 元';
                    })
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("click", function(d) {
                    d3.select(this)
                    .style("opacity", 0.85);
                    tooltip.transition()
                    .duration(200)
                    .style("opacity", 0.9);
                    tooltip.text(function () {
                        return d.properties.TOWN+'\n'+
                        d.properties.VILLAGE+'\n'+
                        numberWithCommas(d.properties.INCOME_MEDIAN)+',000 元';
                    })
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    d3.select(this)
                    .style("opacity", 0.475)
                    tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
                });
            }
            
            //d3 code stolen from http://bost.ocks.org/mike/leaflet/#init
            
            map.on("viewreset", reset);
            reset();
            
            function reset() {
                var topobounds = path.bounds(collection),
                topLeft = topobounds[0],
                bottomRight = topobounds[1];
                
                svg2.attr("width", bottomRight[0] - topLeft[0])
                .attr("height", bottomRight[1] - topLeft[1])
                .style("left", topLeft[0] + "px")
                .style("top", topLeft[1] + "px");
                g2.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
                
                subdist.attr("d", path);
            }

            function projectPoint(x, y) {
                var point = map.latLngToLayerPoint(new L.LatLng(y, x));
                this.stream.point(point.x, point.y);
            }   
            
        });
        
        //twnsublatlng.json Village_NLSC_121_1050219 25.0853403,121.4231634
        
        
        d3.csv("taipei.csv", function(data) {
            
            var transform = d3.geo.transform({point: projectPoint}),
            d3path = d3.geo.path().projection(transform);

            function projectPoint(x, y) {
                var point = map.latLngToLayerPoint(new L.LatLng(x, y));
                this.stream.point(point.x, point.y);
            } 
            
            var lines = {
            "1":{
                color: "brown",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }}, 
            "2": {
                color: "red",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "3": {
                color: "green",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "4": {
                color: "orange",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "4-1": {
                color: "orange",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "5": {
                color: "blue",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "n": {
                color: "red",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "s": {
                color: "green",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }}
            };
            
            data.forEach(function(d) {
                lines[d.line_no].geoLineString.coordinates.push(
                [parseFloat(d.lat), parseFloat(d.lon)]);
            });

            var keys = d3.keys(lines).filter(function(key, d) {
                return key;
            });
            
            var lines2 = [];
            
            keys.forEach(function(key) {
                var tmpdata = lines[key];
                tmpdata['line_no'] = key;
                lines2.push(tmpdata);
            });
            
            var linePath = g.selectAll(".lineConnect")
            .data(lines2)
            .enter()
            .append("path")
            .attr("class", "lineConnect")
            .attr("id", function(d) {return d.line_no; })
            .attr("stroke", function(d) { return d.color; })
            .attr("stroke-width", 1.5)
            .attr("fill", "None")
            .style("opacity", 1)
            .attr("d", function(d) { return d3path(d.geoLineString); });

            d3.select("#mrtline").on("change", switchLine);

            function switchLine() {
                var check = this.checked;
                if (check === true) {
                    linePath.style("opacity", 1);
                } else {
                    linePath.style("opacity", 0);
                }
            }

            var stations = g.selectAll(".circle")
            .data(data)
            .enter()
            .append("circle")
            .attr("r", 3.5)
            .attr("cx", function(d) { return map.latLngToLayerPoint(new L.LatLng(d.lat, d.lon)).x;})
            .attr("cy", function(d) { return map.latLngToLayerPoint(new L.LatLng(d.lat, d.lon)).y;})
            .attr("class", "circle")
            .attr("stroke", function(d) { return lines[d.line_no].color; } )
            .attr("stroke-width", 1.5)
            .attr("fill", "#fff")
            .style("opacity", 0);

            stationName = g2.selectAll(".station-name")
            .data(data)
            .enter()
            .append("text")
            .attr("class", "station-name")
            .attr("id", function(d) { return d.id; })
            .attr("fill", "black")
            .style("font-size", 6)
            .text(function(d) { return d.name; } )
            .style("opacity", 0);
            
            map.on("viewreset", updateMap);
            updateMap();

            d3.select("#station").on("change", switchStation);

            function switchStation() {
                var check = this.checked;
                if (check === true) {
                    stations.style("opacity", 1);
                    stationName.style("opacity", 1);
                } else {
                    stations.style("opacity", 0);
                    stationName.style("opacity", 0);
                }
            }

            function updateMap() {
                linePath.attr("d", function(d) { return d3path(d.geoLineString); });
                stationName.attr("transform", function(d) { 
                    d.x = map.latLngToLayerPoint(new L.LatLng(d.lat, d.lon)).x+7.5;
                    d.y = map.latLngToLayerPoint(new L.LatLng(d.lat, d.lon)).y+2;
                    return "translate("+d.x +","+d.y +")rotate(-20)";
                });
                stations.attr("cx", function(d) { return map.latLngToLayerPoint(new L.LatLng(d.lat, d.lon)).x;})
                .attr("cy", function(d) { return map.latLngToLayerPoint(new L.LatLng(d.lat, d.lon)).y;});
            }

        }); //end of d3.csv("taipei.csv")
            

        function storyTeller() {
            // start
            var i = 0,
            r = $.Deferred();

            var storyData = [
            { type: 0, pan: [25.0656575,121.5896828], selector: "sub", target: "寶湖里", text: "第一名  台北市內湖區寶湖里\n家戶所得中位數：124.0 萬\n類型：別墅社區\n學校：內湖國中、三民國中\n房價：別墅 3 千萬至 5 千萬\n交通：國道 1 號、環東大道"},
            { type: 0, pan: [24.9896,121.59], selector: "sub", target: "政大里", text: "第二名  台北市文山區政大里\n家戶所得中位數：123.6 萬\n類型：別墅社區\n學校：政大實小、政大附中\n房價：透天厝總價 4 千萬、電梯大樓每坪 70 多萬元\n交通：國道 3 號、信義支線" },
           { type: 0, pan: [24.9263674,121.4975], selector: "sub", target: "華城里", text: "第三名  新北市新店區華城里\n家戶所得中位數：119.7 萬\n類型：別墅社區\n學校：康橋中小學\n房價：別墅 3 千萬至 5 千萬\n交通：國道 3 號、環河快速道路" },
            { type: 2, pan: [25.045,121.547], center: [[25.0292997,121.5030736], [25.0263064,121.5263363], [25.0645017,121.4959642], [25.0601717,121.5417976], [25.0287132,121.5548065], [25.0294912,121.4803741]], selector: "dist", target: ["中正區", "大安區", "大同區", "松山區", "信義區", "萬華區"], text: "台北市中心區域的中正、大安、大同、松山、信義，以及周邊的萬華等區內部顏色較相近，相對而言區域內較為均值。" },
            { type: 1, pan: [25.045,121.547], center: [25.0263064,121.5263363], selector: "dist", target: "大安區", text: "大安區雖然沒有在村里排名拔得頭籌，整體收入都還是在雙北的前段班。" },
            { type: 3, pan: [25.045,121.547], center: [[24.991582, 121.572439], [25.088473, 121.593980], [25.06,121.532]], selector: "dist", target: ["文山區", "內湖區", "中山區"], text: "周圍的文山區、內湖區、中山區則有部分村里一枝獨秀的狀況，區域內部較不平均。" },
            { type: 3, pan: [25.045,121.547], center: [[25.036521, 121.606516], [25.110375, 121.543105], [25.1531443,121.4833168]], selector: "dist", target: ["南港區", "士林區", "北投區"], text: "士林、北投、南港則是在河堤、山區，與仍有開發問題的社子島有相對較低的所得。" },
            { type: 3, pan: [25.045,121.547], center: [[24.935879, 121.532208], [24.990909, 121.493024], [25.008994, 121.519721], [25.014647, 121.457957], [25.074577, 121.660210]], selector: "dist", target: ["新店區", "中和區", "永和區", "板橋區", "汐止區"], text: "新北市普遍所得較高的地區則是大家所熟悉與台北市緊密相連的新店區、中永和區、板橋區、汐止區。" },
            { type: 3, pan: [25.045,121.547], center: [[25.186485, 121.457590], [25.097718, 121.357951], [24.968029, 121.400650], [24.904097, 121.399486]], selector: "dist", target: ["淡水區", "林口區", "樹林區", "三峽區"], text: "另外淡水區，以及西邊的林口區長庚醫院周邊，以及西南邊位於三峽、樹林的台北大學特區亦是所得較高的區域。" },
            { type: 0, pan: [25.045,121.547], center: [25.0263064,121.5263363], selector: "none", target: "", text: "接下來，換你自由探索地圖囉！" }
            ]  

            function storyLine() {
                var type = storyData[i].type,
                pan = storyData[i].pan,
                center = storyData[i].center,
                target = storyData[i].target,
                text = storyData[i].text,
                selector;


                if (storyData[i].selector === "sub") {
                    selector = "#";
                } else if (storyData[i].selector === "dist") {
                    selector = ".";
                } else {
                    selector = "";
                }

                if (type === 0) {
                    type0();
                } else if (type === 1) {
                    type1();
                } else if (type === 2) {
                    type2();
                } else if (type === 3) {
                    type3();
                }

                story.text(text);

                var nextBtn = story.append("svg")
                    .attr("id", "next")
                    .append("path")
                    .attr("class", "btn")
                    .attr("d", "m0,0L7,0L21,50L7,100L0,100L14,50z")
                    .attr("fill", "#d0d0d0")
                    .on("mouseover", function(){
                        d3.select(this)
                        .attr("fill", "#74AFAD");
                    })
                    .on("mouseout", function(){
                        d3.select(this)
                        .attr("fill", "#d0d0d0");
                    });

                var backBtn = story.append("svg")
                .attr("id", "back")
                .append("path")
                .attr("class", "btn")
                .attr("d", "m30,0L23,0L9,50L23,100L30,100L16,50z")
                .attr("fill", "#d0d0d0")
                .on("mouseover", function(){
                    d3.select(this)
                    .attr("fill", "#74AFAD");
                })
                .on("mouseout", function(){
                    d3.select(this)
                    .attr("fill", "#d0d0d0");
                });

                var exitBtn = story.append("svg")
                .attr("id", "exit")
                .append("path")
                .attr("class", "btn")
                .attr("d", "m0,0L5,5L10,10L5,5L0,10L5,5L10,0L5,5z")
                .attr("stroke-width", 4)
                .attr("stroke", "#d0d0d0")
                .attr("transform", "translate(4,4)")
                .on("mouseover", function(){
                    d3.select(this)
                    .attr("stroke", "#74AFAD");
                })
                .on("mouseout", function(){
                    d3.select(this)
                    .attr("stroke", "#d0d0d0");
                })
                .on("click", function() {
                    exit = true;
                    distname.style("opacity", 0);
                    tooltip.style("opacity", 0);
                    subdist.style("opacity", 0.475);
                    story.remove();
                    interactive();
                    map.panTo([25.045,121.547]);
                });

                if (i === storyData.length-1) {
                    nextBtn.style("opacity", 0);
                    backBtn.on("click", function() { clickBack(); } );
                    interactive();
                    setTimeout(function() {
                        distname.remove();
                        story.style("opacity", 0);
                    }, 4000);
                } else if (i === 0) {
                    nextBtn.on("click", function() { clickNext(); } );
                    backBtn.attr("opacity", 0);
                } else {
                    nextBtn.on("click", function() { clickNext(); } );
                    backBtn.on("click", function() { clickBack(); } );
                }

                function type0() {

                    if (exit === false) {

                        if (selector === "#") {
                            d3.select(selector+target)
                            .style("opacity", 0.85);
                        } else if (selector === ".") {
                            d3.selectAll(selector+target)
                            .style("opacity", 0.85);                        
                        }

                        map.panTo(pan);

                        if (i < storyData.length-1) {
                            setTimeout(function () {
                                clickNext();
                            }, 3500);
                        } else {
                            exit = true;
                            distname.style("opacity", 0);
                        }
                    } else {
                        return;
                    }

                } // end of type0()


                function type1() {

                    if (exit === false) {

                        map.panTo(pan);

                        var textPosition = map.latLngToLayerPoint(new L.LatLng(center[0], center[1]));

                        if (selector === "#") {
                            d3.select(selector+target)
                            .style("opacity", 0.85);
                        } else if (selector === ".") {
                            d3.selectAll(selector+target)
                            .style("opacity", 0.85);                        
                        };

                        d3.select(".story")
                        .style("white-space", "pre-wrap");

                        distname.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                        distname.text(function () {
                                return target;
                        })
                        .style("left", (textPosition.x + 10) + "px")
                        .style("top", (textPosition.y - 28) + "px");

                        if (i < storyData.length-1) {
                            setTimeout(function () {
                                clickNext();
                            }, 3500);
                        } else {
                            exit = true;
                            distname.style("opacity", 0);
                        }
                    } else {
                        return;
                    }

                } // end of type1()

                function type2() {

                    if (exit === false) {

                        map.panTo(pan);

                        var j = 0, n = target.length, current = i;

                        d3.select(".story")
                        .style("white-space", "pre-wrap");
                                
                        function show() {

                            if ( current !== i | exit === true ) {
                                clearInterval(distSwitch);
                                return;
                            }

                            var textPosition = map.latLngToLayerPoint(new L.LatLng(center[j][0], center[j][1]));

                            // remove previous
                            subdist.style("opacity", 0.475);
                            distname.style("opacity", 0);
                            // highlight current
                            if (selector === "#") {
                                d3.select(selector+target[j])
                                .style("opacity", 0.85);
                            } else {
                                d3.selectAll(selector+target[j])
                                .style("opacity", 0.85);                      
                            }
                            distname.style("opacity", 0.9);

                            distname.text(function () {
                                return target[j];
                            })
                            .style("left", (textPosition.x + 10) + "px")
                            .style("top", (textPosition.y - 28) + "px");

                            j++;

                            if ( j >= n ) {
                                clearInterval(distSwitch);
                            }
                        }

                        show();
                        var distSwitch;
                        setTimeout(function() {
                            distSwitch = setInterval(show, 1500);
                        }, 2000);


                        if (i < storyData.length-1) {
                            setTimeout(function () {
                                clickNext();
                            }, 1500*n+4000);
                        } else {
                            exit = true;
                            distname.style("opacity", 0);
                        };
                    } else {
                        return;
                    }

                }  // end of type2()


                function type3() {

                    if (exit === false) {

                        var j = 0, n = target.length, current = i;

                        d3.select(".story")
                        .style("white-space", "pre-wrap");
                            
                        function show() {

                            if ( current !== i | exit === true ) {
                                clearInterval(distSwitch);
                                return;
                            }

                            // remove previous
                            subdist.style("opacity", 0.475);
                            distname.style("opacity", 0);
                            // highlight current
                            if (selector === "#") {
                                d3.select(selector+target[j])
                                .style("opacity", 0.85);
                            } else {
                                d3.selectAll(selector+target[j])
                                .style("opacity", 0.85);                        
                            }
                            map.panTo(center[j]);
                            distname.style("opacity", 0.9);

                            distname.text(function () {
                                return target[j];
                            })
                            .style("left", "49%")
                            .style("top", "50%");
                            
                            j++;

                            if ( j >= n ) {
                                clearInterval(distSwitch);
                            }
                        }

                        show();
                        var distSwitch;
                        setTimeout(function() {
                            distSwitch = setInterval(show, 1500);
                        }, 2000);

                        if (i < storyData.length-1) {
                            setTimeout(function () {
                                clickNext();
                            }, 2500*n+4000);
                        } else {
                            exit = true;
                            distname.style("opacity", 0);
                        }
                    } else {
                        return;
                    }
                    
                
                }  // end of type3()

                
            } // end of storyLine();

            function clickBack() {
                subdist.style("opacity", 0.475);
                distname.style("opacity", 0);
                i--;
                storyLine();
            }


            function clickNext() {
                subdist.style("opacity", 0.475);
                distname.style("opacity", 0);
                i++;
                storyLine();
            }

            storyLine();

        } // end of storyTeller() 

        // remove all after display. navigation? color? mapcontrol?

        // chart1
        var citydata = {
            "tpe": { "q1": 392, "median": 732, "q3": 1427, "mean": 1434},
            "ntp": { "q1": 360, "median": 600, "q3": 1054, "mean": 895}
        };

        var subdistdata = [
		  {
		    "dist": "松山區",
		    "subdist": "東昌里",
		    "mean": 1072.7,
		    "median": 93.6,
		    "q1": 47.4,
		    "q3": 181.6
		  },
		  {
		    "dist": "信義區",
		    "subdist": "興隆里",
		    "mean": 908.3,
		    "median": 80.6,
		    "q1": 36.8,
		    "q3": 189.5
		  },
		  {
		    "dist": "士林區",
		    "subdist": "菁山里",
		    "mean": 610.4,
		    "median": 64.6,
		    "q1": 38.8,
		    "q3": 107.6
		  },
		  {
		    "dist": "士林區",
		    "subdist": "永福里",
		    "mean": 595.3,
		    "median": 78.8,
		    "q1": 42.2,
		    "q3": 170
		  },
		  {
		    "dist": "士林區",
		    "subdist": "新安里",
		    "mean": 578.5,
		    "median": 64.4,
		    "q1": 34,
		    "q3": 143
		  },
		  {
		    "dist": "中正區",
		    "subdist": "東門里",
		    "mean": 543.1,
		    "median": 88.7,
		    "q1": 45.8,
		    "q3": 189
		  },
		  {
		    "dist": "大安區",
		    "subdist": "民輝里",
		    "mean": 430.7,
		    "median": 94,
		    "q1": 44.2,
		    "q3": 210.3
		  },
		  {
		    "dist": "松山區",
		    "subdist": "福成里",
		    "mean": 416.2,
		    "median": 90.8,
		    "q1": 42.9,
		    "q3": 188.2
		  },
		  {
		    "dist": "信義區",
		    "subdist": "安康里",
		    "mean": 415.4,
		    "median": 99.4,
		    "q1": 47,
		    "q3": 218
		  },
		  {
		    "dist": "中山區",
		    "subdist": "新福里",
		    "mean": 409.6,
		    "median": 62.4,
		    "q1": 35.1,
		    "q3": 116.2
		  }
		]

        var chart1width = parseInt(d3.select("#chart1").style("width")), 
        chart1height = parseInt(d3.select("#chart1").style("height"));
        
        var chart1 = d3.select("#chart1").append("svg")
        .attr("width", chart1width)
        .attr("height", chart1height)
        .append("g")
        .attr("transform", "translate(" + chart1width*0.08 + "," + chart1height*0.01 + ")");

        var x = d3.scale.ordinal()
        .domain(subdistdata.map(function(a) { return a.subdist; }))
        .rangePoints([chart1width*0.05, chart1width*0.8]);

        var xBand = d3.scale.ordinal()
        .domain(subdistdata.map(function(a) { return a.subdist; }))
        .rangeRoundBands([0, chart1width*0.85]);
        
        var y = d3.scale.linear()
        .range([chart1height*0.85, 10]);
        
        var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");
        
        var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");

        var mean = d3.svg.line()
        .x(function(d) { return x(d.subdist); })
        .y(function(d) { return y(d.mean); });
        
        var median = d3.svg.line()
        .x(function(d) { return x(d.subdist); })
        .y(function(d) { return y(d.median); });
        
        y.domain([0, d3.max(subdistdata, function(d) { return d.mean; })]);

        chart1.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + (chart1height*0.85) + ")")
        .call(xAxis)
        .selectAll("text")
	    .attr("transform", "rotate(25)")
	    .style("text-anchor", "start");
        
        chart1.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + 10 +",0)")
        .call(yAxis)
        .append("text")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .attr("fill", "#558C89")
        .style("font-weight", 400)
        .attr("transform", "rotate(-90)")
        .text("年度所得總額（單位：萬元）");

        chart1.selectAll(".mean")
		.data(subdistdata)
		.enter().append("circle")
		.attr("class", "mean")
		.attr("id", function(d) { return "c"+d.subdist; })
		.attr("r", 3.5)
		.attr("cx", function(d) { return x(d.subdist); })
		.attr("cy", function(d) { return y(d.mean); })
		.style("fill", "#EB7F00")
		.on("mouseover", chart1mouseover)
		.on("mouseout", chart1mouseout)
		
		chart1.selectAll(".meantext")
		.data(subdistdata)
		.enter().append("text")
		.attr("class", "meantext")
		.attr("id", function(d) { return "tt"+d.subdist; })
		.attr("x", function(d) { return x(d.subdist)+6; })
		.attr("y", function(d) { return y(d.mean)+3; })
		.text(function(d) { return d.mean; });

		chart1.selectAll(".median")
		.data(subdistdata)
		.enter().append("circle")
		.attr("class", "median")
		.attr("id", function(d) { return "c"+d.subdist; })
		.attr("r", 3.5)
		.attr("cx", function(d) { return x(d.subdist); })
		.attr("cy", function(d) { return y(d.median); })
		.style("fill", "#1595A3")
		.on("mouseover", chart1mouseover)
		.on("mouseout", chart1mouseout);

		chart1.selectAll(".mediantext")
		.data(subdistdata)
		.enter().append("text")
		.attr("class", "mediantext")
		.attr("id", function(d) { return "tt"+d.subdist; })
		.attr("x", function(d) { return x(d.subdist)+6; })
		.attr("y", function(d) { return y(d.median)+3; })
		.text(function(d) { return d.median; });


		chart1.selectAll(".q1")
		.data(subdistdata)
		.enter().append("circle")
		.attr("class", "q1")
		.attr("id", function(d) { return "c"+d.subdist; })
		.attr("r", 3.5)
		.attr("cx", function(d) { return x(d.subdist); })
		.attr("cy", function(d) { return y(d.q1); })
		.style("fill", "#ACF0F2")
		.on("mouseover", chart1mouseover)
		.on("mouseout", chart1mouseout);

		chart1.selectAll(".q1text")
		.data(subdistdata)
		.enter().append("text")
		.attr("class", "q1text")
		.attr("id", function(d) { return "tt"+d.subdist; })
		.attr("x", function(d) { return x(d.subdist)+6; })
		.attr("y", function(d) { return y(d.q1)+8; })
		.text(function(d) { return d.q1; });

		chart1.selectAll(".q3")
		.data(subdistdata)
		.enter().append("circle")
		.attr("class", "q3")
		.attr("id", function(d) { return "c"+d.subdist; })
		.attr("r", 3.5)
		.attr("cx", function(d) { return x(d.subdist); })
		.attr("cy", function(d) { return y(d.q3); })
		.style("fill", "#225378")
		.on("mouseover", chart1mouseover)
		.on("mouseout", chart1mouseout);

		chart1.selectAll(".q3text")
		.data(subdistdata)
		.enter().append("text")
		.attr("class", "q3text")
		.attr("id", function(d) { return "tt"+d.subdist; })
		.attr("x", function(d) { return x(d.subdist)+6; })
		.attr("y", function(d) { return y(d.q3)+3; })
		.text(function(d) { return d.q3; });

		chart1.selectAll(".chart1rect")
		.data(subdistdata)
		.enter().append("rect")
		.attr("class", "chart1rect")
		.attr("id", function(d) { return "r"+d.subdist; })
		.attr("x", function(d) { return xBand(d.subdist); })
        .attr("width", xBand.rangeBand())
        .attr("y", 0 )
		.attr("height", chart1height*0.85 )
		.attr("fill", "black")
		.style("opacity", 0)
		.on("mouseover", chart1mouseover)
		.on("mouseout", chart1mouseout);

		var color = [
		{"name": "平均數", "color": "#EB7F00"},
		{"name": "第三分位數", "color": "#225378"},
		{"name": "中位數", "color": "#1595A3"},
		{"name": "第一分位數", "color": "#ACF0F2"},
		]

		var chart1legend = chart1.selectAll(".chart1legend")
		.data(color)
		.enter().append("g")
		.attr("class", "chart1legend")
		.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

		chart1legend.append("rect")
		.attr("x", chart1width*0.8)
		.attr("width", 17)
		.attr("height", 17)
		.style("fill", function(d) {return d.color});

		chart1legend.append("text")
		.attr("x", chart1width*0.795)
		.attr("y", 9)
		.attr("dy", ".35em")
		.style("text-anchor", "end")
		.text(function(d) { return d.name; });

		function chart1mouseover(d) {
			d3.selectAll("#c"+d.subdist)
			.attr("r", 5);
			d3.selectAll("#tt"+d.subdist)
			.style("opacity", 1);
		}

		function chart1mouseout(d) {
			d3.selectAll("#c"+d.subdist)
			.attr("r", 3.5);
			d3.selectAll("#tt"+d.subdist)
			.style("opacity", 0);
		}


        </script>
    </body>
</html>
